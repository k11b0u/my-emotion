<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root { color-scheme: light dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:880px;margin:20px auto;padding:0 12px}
  .card{border:1px solid #333;border-radius:14px;padding:16px;margin:14px 0;background:#121212;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1e1e1e;color:#f1f1f1;cursor:pointer;transition:background .15s ease, transform .02s ease}
  button:hover:not(:disabled){ background:#2a2a2a; }
  button:active:not(:disabled){ transform:translateY(1px); }
  button:disabled{ background:#2a2a2a; color:#9aa; border-color:#444; opacity:1; cursor:not-allowed; }
  code{background:#1b1b1b;padding:2px 6px;border-radius:6px}
  .muted{color:#b0b0b0}
  input,textarea,select{width:100%;padding:8px;border:1px solid #444;border-radius:10px;background:#1a1a1a;color:#eee}
  input::placeholder,textarea::placeholder{color:#9aa}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > * { flex:1 }
  small{color:#9aa}
  .logbox{white-space:pre-wrap;height:180px;overflow:auto;background:#0f0f0f;color:#e8e8e8;border:1px solid #333;border-radius:8px;padding:8px;font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<h1>Emotion Record</h1>

<div class="card">
  <h2>çŠ¶æ…‹</h2>
  <p>BLE: <span id="bleState">æœªæ¥ç¶š</span>ï¼Spotify: <span id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</span></p>
  <div class="row">
    <button id="btnBle">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šï¼ˆCOOSPOï¼‰</button>
    <button id="btnSp">Spotifyãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btnStart">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
    <button id="btnStop" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</button>
  </div>

  <div class="row" style="margin-top:8px">
    <div>
      <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æç”¨ãƒ©ãƒ™ãƒ«ï¼‰</label>
      <select id="cond">
        <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
        <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
        <option value="MUSIC" selected>MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
        <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
      </select>
      <small>â€» ã“ã“ã¯ã€Œè§£æç”¨ã«è¨˜éŒ²ã™ã‚‹ãƒ©ãƒ™ãƒ«ã€ã€‚å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆä½ç½®ã§åˆ‡æ›¿ã€‚</small>
    </div>
    <div>
      <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
      <input id="pid" placeholder="hiro" value="hiro"/>
    </div>
  </div>
  <p class="muted">â€» Spotifyã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‹ã§å†ç”Ÿä¸­ã®ãƒ‡ãƒã‚¤ã‚¹ã€ãŒã‚ã‚‹ã¨ãã ã‘åˆ¶å¾¡ã—ã¾ã™ï¼ˆå‹æ‰‹ã«éŸ³ã¯é³´ã‚Šã¾ã›ã‚“ï¼‰ã€‚</p>
</div>

<div class="card">
  <h2>ãƒ­ã‚°</h2>
  <pre id="log" class="logbox"></pre>
  <div class="row">
    <button id="btnCsv" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnClear">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
  <small class="muted">åˆ—: timestamp,datetime,pid,day,session_id,block,condition,hr,rmssd,rmssd_ms,z_hr,z_rmssd,d_hr,d_rmssd,emotion,track_id,track_name,artists,context_uri,hr_base,rmssd_base,sd_hr,sd_rmssd,is_playing,exercise,valid_for_rank,mood,relax,note</small>
</div>

<div class="card">
  <h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div class="row">
    <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
    <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
  </div>
  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
  <button id="btnNote">è¿½åŠ </button>
</div>

<script>
// ====================== è¨­å®šï¼ˆğŸ‘†å¿…ãšç½®ãæ›ãˆï¼‰ ======================
const SPOTIFY_CLIENT_ID = "7838a0cf003644ae8b5f3f75b9eb534e";  // â† Spotifyã®Client ID
const REDIRECT_URI       = "https://my-emotion2025.vercel.app/"; // â† Spotifyãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®Redirect URIã¨ä¸€è‡´

// ä»‹å…¥ã§ä½¿ã†ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆï¼ˆä»»æ„ï¼šå¿…è¦ãªã‚‰ç½®ãæ›ãˆï¼‰
const PLAYLIST_TENSION_TO_CALM = "spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT = "spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN   = "spotify:playlist:2m9HoHfpO0tk5eky1fopVu";

// SwitchBotã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆVercel Functionsã‚„Cloudflareç­‰ã‚’ä½¿ã†å ´åˆï¼‰
const SWITCHBOT_PROXY = "/api/switchbot"; // ä½¿ã‚ãªã„ãªã‚‰ãã®ã¾ã¾ã§OK

// Spotifyã‚¹ã‚³ãƒ¼ãƒ—
const SCOPES = [
  "user-read-playback-state","user-modify-playback-state",
  "playlist-read-private","playlist-read-collaborative","streaming"
].join(" ");
// ==================================================================

// ---- ç”»é¢è¦ç´ 
const logEl      = document.getElementById("log");
const bleStateEl = document.getElementById("bleState");
const spStateEl  = document.getElementById("spState");
const btnCsv     = document.getElementById("btnCsv");
const btnClear   = document.getElementById("btnClear");
const condSel    = document.getElementById("cond");

// ---- çŠ¶æ…‹å¤‰æ•°
let hr = null;           // å¿ƒæ‹ï¼ˆBPMï¼‰
let rrList = [];         // ç›´è¿‘ã®RRé–“éš”ï¼ˆç§’ï¼‰
let prevHR = null, prevRMSSD = null;

let sessionId = Math.random().toString(36).slice(2,10);
let timer = null;
let spotifyAccessToken = null;

// å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆEWMAï¼‰
let hr_base = 70, sd_hr = 8;
let rmssd_base = 0.040, sd_rmssd = 0.015;
const EWMA = 0.05;

// CSVï¼ˆå…ˆé ­ã«ãƒ˜ãƒƒãƒ€ï¼‰
let csvRows = [[
  "timestamp","datetime","pid","day","session_id","block","condition",
  "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
  "emotion",
  "track_id","track_name","artists","context_uri",
  "hr_base","rmssd_base","sd_hr","sd_rmssd",
  "is_playing","exercise","valid_for_rank",
  "mood","relax","note"
]];

// ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = ""; }
function isoNow(){ return new Date().toISOString().replace("T"," ").slice(0,19); }
function mean(a){ return a.length ? a.reduce((x,y)=>x+y,0)/a.length : null; }
function calcRMSSD(rrs){
  if(rrs.length < 3) return null;
  let sum=0, n=0;
  for(let i=1;i<rrs.length;i++){ const d=rrs[i]-rrs[i-1]; sum+=d*d; n++; }
  return Math.sqrt(sum/n); // å˜ä½: ç§’
}

// ========= Web Bluetoothï¼ˆ0x180Dï¼‰ =========
async function connectBLE(){
  try{
    log("BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{services:["heart_rate"]}],
      optionalServices:["heart_rate"]
    });
    const server  = await dev.gatt.connect();
    const service = await server.getPrimaryService("heart_rate");
    const ch = await service.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();

    ch.addEventListener("characteristicvaluechanged", e=>{
      const v = e.target.value;
      const flags  = v.getUint8(0);
      const hrVal  = (flags & 0x01) ? v.getUint16(1,true) : v.getUint8(1);
      if(Number.isFinite(hrVal)) hr = hrVal;

      let idx = (flags & 0x01) ? 3 : 2;
      const rrLocal = [];
      while(idx+1 < v.byteLength){
        const rr = v.getUint16(idx,true)/1024.0; // sec
        rrLocal.push(rr);
        idx += 2;
      }
      if(rrLocal.length){
        rrList.push(...rrLocal);
        if(rrList.length>60) rrList = rrList.slice(-60);
      }
      bleStateEl.textContent = `æ¥ç¶šä¸­ï¼ˆHR=${hrVal})`;
    });

    bleStateEl.textContent = "æ¥ç¶šå®Œäº†";
    log("BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){
    bleStateEl.textContent = "æœªæ¥ç¶š";
    log("BLE error: "+err.message);
  }
}

// ========= Spotifyï¼ˆPKCEï¼‰ =========
function base64url(bytes){
  return btoa(String.fromCharCode(...new Uint8Array(bytes)))
    .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
async function pkce(){
  const ver = base64url(crypto.getRandomValues(new Uint8Array(32)));
  const dig = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(ver));
  const chal = base64url(dig);
  sessionStorage.setItem("pkce_verifier", ver);
  return chal;
}
async function loginSpotify(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  if(!code){
    const challenge = await pkce();
    const url = "https://accounts.spotify.com/authorize?" + new URLSearchParams({
      client_id: SPOTIFY_CLIENT_ID,
      response_type: "code",
      redirect_uri: REDIRECT_URI,
      scope: SCOPES,
      code_challenge_method: "S256",
      code_challenge: challenge
    });
    location.href = url;
    return;
  }
  const ver = sessionStorage.getItem("pkce_verifier");
  const body = new URLSearchParams({
    grant_type:"authorization_code",
    code,
    redirect_uri:REDIRECT_URI,
    client_id:SPOTIFY_CLIENT_ID,
    code_verifier:ver
  });
  const r = await fetch("https://accounts.spotify.com/api/token", {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });
  const tok = await r.json();
  if(tok.access_token){
    spotifyAccessToken = tok.access_token;
    spStateEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿";
    log("Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†");
    history.replaceState({}, "", REDIRECT_URI); // URLã®?codeå‰Šé™¤
  }else{
    log("Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(tok).slice(0,300));
  }
}
async function spRequest(method, url, body){
  if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url, {
    method,
    headers:{ "Authorization":"Bearer "+spotifyAccessToken, "Content-Type":"application/json" },
    body: body? JSON.stringify(body): undefined
  });
}
async function ensureShuffleOn(){
  try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }catch(_){}
}
async function playPlaylist(uri){
  try{
    await ensureShuffleOn();
    const r = await spRequest("PUT","https://api.spotify.com/v1/me/player/play",{ context_uri: uri, position_ms: 0 });
    if(!r.ok){ log("play err: "+(await r.text()).slice(0,200)); }
  }catch(e){ log("play err: "+e.message); }
}
async function getCurrentPlaying(){
  try{
    const r = await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing");
    if(r.status===204) return null;
    return await r.json();
  }catch(_){ return null; }
}
function extractTrackInfo(j){
  try{
    if(!j || !j.is_playing || !j.item) return {track_id:"",track_name:"",artists:"",context_uri:""};
    const item=j.item;
    const artists=(item.artists||[]).map(a=>a.name).join(", ");
    const ctx = (j.context && j.context.uri) ? j.context.uri : "";
    return { track_id:item.id||"", track_name:item.name||"", artists, context_uri: ctx };
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:""}; }
}

// ========= SwitchBotï¼ˆä»»æ„ï¼‰ =========
async function switchbotCommand(deviceId, command){
  try{
    const r = await fetch(SWITCHBOT_PROXY, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ deviceId, command })
    });
    if(!r.ok) log("SwitchBot err: "+r.status);
  }catch(e){ log("SwitchBot fetch err: "+e.message); }
}

// ========= ã—ãã„å€¤ãƒ«ãƒ¼ãƒ«ï¼ˆç°¡æ˜“ï¼‰ =========
function decideEmotion(hrValue, rmssd){
  if(rmssd==null) return "unknown";
  if(rmssd < 0.025) return "tension"; // â€»ã—ãã„å€¤ã¯å€‹äººã§èª¿æ•´
  if(rmssd > 0.060) return "calm";
  return "unknown";
}

// ========= 1åˆ†ã”ã¨é›†è¨ˆãƒ«ãƒ¼ãƒ— =========
async function minuteTick(){
  const now = Date.now();
  const dayStr = new Date().toLocaleDateString("ja-JP");
  const pid = (document.getElementById("pid").value||"").trim() || "pid";
  const condition = condSel.value; // NONE/SCENT/MUSIC/BOTH
  const rmssd = calcRMSSD(rrList.slice(-10)); // ç›´è¿‘RR
  const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
  const z_hr = (hr!=null) ? (hr-hr_base)/sd_hr : "";
  const z_rmssd = (rmssd!=null) ? (rmssd-rmssd_base)/sd_rmssd : "";
  const d_hr = (prevHR!=null && hr!=null) ? (hr-prevHR) : "";
  const d_rmssd = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD) : "";

  // Spotifyã®ç¾åœ¨æ›²ï¼ˆ204=æœªå†ç”Ÿãªã‚‰nullï¼‰
  let is_playing = 0, track = {track_id:"",track_name:"",artists:"",context_uri:""};
  if(spotifyAccessToken){
    const j = await getCurrentPlaying();
    if(j && j.is_playing){ is_playing = 1; track = extractTrackInfo(j); }
  }

  // é‹å‹•ã–ã£ãã‚Šé™¤å¤–
  const exercise = (hr!=null && hr_base!=null && hr >= hr_base + 25) ? 1 : 0;

  // æ„Ÿæƒ…ï¼ˆç°¡æ˜“ï¼‰
  const emotion = decideEmotion(hr, rmssd);

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ï¼ˆä»‹å…¥ãªã—Ã—ä¸­æ–­ãªã—Ã—é‹å‹•ãªã—Ã—å†ç”Ÿä¸­ï¼‰
  const valid_for_rank = (condition==="NONE" && is_playing && !exercise) ? 1 : 0;

  // CSVã¸
  csvRows.push([
    now, isoNow(), pid, dayStr, sessionId, "block1", condition,
    hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
    emotion,
    track.track_id, track.track_name, track.artists, track.context_uri,
    hr_base, rmssd_base, sd_hr, sd_rmssd,
    is_playing, exercise, valid_for_rank,
    "", "", "" // mood, relax, note ã¯å¾Œã§è¿½è¨˜
  ]);

  // ï¼ˆå¿…è¦ãªã‚‰ï¼‰ã“ã“ã§ä»‹å…¥ONã«ã™ã‚‹ï¼š
  // if((condition==="MUSIC" || condition==="BOTH") && emotion==="tension" && is_playing){
  //   await playPlaylist(PLAYLIST_TENSION_TO_CALM);
  // }
  // if((condition==="BOTH" || condition==="SCENT") && emotion!=="unknown"){
  //   await switchbotCommand("YOUR_DEVICE_ID", "press");
  // }

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®ç·©ã‚„ã‹ãªæ›´æ–°ï¼ˆã»ã¼ä¸­ç«‹åŸŸã ã‘ï¼‰
  if(rmssd!=null && hr!=null && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
    hr_base    = (1-EWMA)*hr_base    + EWMA*hr;
    rmssd_base = (1-EWMA)*rmssd_base + EWMA*rmssd;
    sd_hr      = (1-EWMA)*sd_hr      + EWMA*Math.abs(hr-hr_base);
    sd_rmssd   = (1-EWMA)*sd_rmssd   + EWMA*Math.abs(rmssd-rmssd_base);
  }

  prevHR = hr; prevRMSSD = rmssd;
}

// ========= ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ =========
async function startSession(){
  if(!spotifyAccessToken) log("â€» Spotifyæœªãƒ­ã‚°ã‚¤ãƒ³ã§ã‚‚è¨˜éŒ²ã¯å‹•ãã¾ã™ï¼ˆåˆ¶å¾¡ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰");
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").disabled  = false;
  btnCsv.disabled = true;

  // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  sessionId = Math.random().toString(36).slice(2,10);
  log("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: " + sessionId);

  // 1åˆ†ãƒ«ãƒ¼ãƒ—é–‹å§‹ï¼ˆæ¯åˆ†ã®åˆ‡æ›¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã–ã£ãã‚Š1ç§’å‘¨æœŸã§ç›£è¦–ï¼‰
  let lastMinute = Math.floor(Date.now()/60000);
  timer = setInterval(async ()=>{
    const m = Math.floor(Date.now()/60000);
    if(m !== lastMinute){
      await minuteTick();
      lastMinute = m;
      // æ¬¡ã®åˆ†ã¸å‘ã‘ãŸRRã®å¤ã„åˆ†ã‚’è»½ãæƒé™¤ï¼ˆä»»æ„ï¼‰
      if(rrList.length>60) rrList = rrList.slice(-60);
    }
  }, 1000);
}
function stopSession(){
  if(timer){ clearInterval(timer); timer=null; }
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnStop").disabled  = true;
  btnCsv.disabled = false;
  log("ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†");
}

// ========= UIã‚¤ãƒ™ãƒ³ãƒˆ =========
document.getElementById("btnBle").onclick   = connectBLE;
document.getElementById("btnSp").onclick    = loginSpotify;
document.getElementById("btnStart").onclick = startSession;
document.getElementById("btnStop").onclick  = stopSession;

// ã‚¢ãƒ³ã‚±ï¼šæœ€å¾Œã®è¡Œã¸è¿½è¨˜ï¼ˆãªã‘ã‚Œã°æ–°è¦è¡Œã‚’ä½œã‚‹ï¼‰
document.getElementById("btnNote").onclick = ()=>{
  const mood  = document.getElementById("mood").value||"";
  const relax = document.getElementById("relax").value||"";
  const notes = document.getElementById("notes").value||"";
  if(csvRows.length>1){
    const last = csvRows[csvRows.length-1];
    last[last.length-3] = mood;
    last[last.length-2] = relax;
    last[last.length-1] = notes;
  }else{
    const pid = (document.getElementById("pid").value||"pid");
    const dayStr = new Date().toLocaleDateString("ja-JP");
    csvRows.push([
      Date.now(), isoNow(), pid, dayStr, sessionId, "block1", condSel.value,
      "","","","","","","","",
      "","","","",
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      0,0,0,
      mood,relax,notes
    ]);
  }
  log("ã‚¢ãƒ³ã‚±è¿½åŠ ");
};

// CSVä¿å­˜
btnCsv.onclick = ()=>{
  const blob = new Blob([csvRows.map(r=>r.join(",")).join("\n")], {type:"text/csv"});
  const dayStr = new Date().toISOString().slice(0,10);
  const a = Object.assign(document.createElement("a"), {
    href: URL.createObjectURL(blob),
    download: `emotion_log_${dayStr}_${sessionId}.csv`
  });
  a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
};

// ç”»é¢ãƒ­ã‚°æ¶ˆå»
btnClear.onclick = clearLog;

// æ—¢ã« ?code= ãŒä»˜ã„ã¦æˆ»ã£ã¦ããŸã‚‰è‡ªå‹•ã§ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›
if(new URLSearchParams(location.search).get("code")) loginSpotify();
</script>
</body>
</html>
