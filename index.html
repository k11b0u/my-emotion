<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root{
    color-scheme: light dark;
    --bg:#0f1115; --panel:#161a22; --panel2:#131722; --line:#283143; --txt:#eef2f7; --muted:#9aa6b2;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --pri:#4f46e5; --acc:#06b6d4;
  }
  html,body{background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
  h1{font-size:22px;margin:0}
  h2{font-size:18px;margin:0 0 8px}
  .wrap{max-width:1160px;margin:0 auto;padding:14px}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,21,.9),rgba(15,17,21,.75));backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--panel2);font-size:13px}
  .grid{display:grid;gap:12px;margin-top:12px}
  @media (min-width:980px){ .grid{grid-template-columns:1.05fr .95fr} }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 0}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#1c2130;color:var(--txt);cursor:pointer;transition:.15s}
  .btn:hover:not(:disabled){ transform:translateY(-1px); background:#22283a }
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn-primary{background:linear-gradient(180deg,#3b82f6,#4f46e5);border-color:#3840a8}
  .btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d}
  .btn-ghost{background:transparent}
  .switch{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;background:var(--panel2);padding:8px 10px}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#111525;color:var(--txt)}
  .muted{color:var(--muted);font-size:13px}
  .logbox{white-space:pre-wrap;height:260px;overflow:auto;background:#0c111b;color:#e6ebf2;border:1px solid var(--line);
          border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace}
  .progress{height:12px;background:#0c111b;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:#121827;border:1px solid var(--line);border-radius:16px;padding:18px;max-width:460px;width:92%}
  .tiny{font-size:12px}
  details > summary{cursor:pointer}
</style>
</head>
<body>

<div class="topbar">
  <div class="toprow wrap">
    <div class="row" style="gap:12px;align-items:center">
      <h1>Emotion Record</h1>
      <div class="chips">
        <span class="chip">BLE: <strong id="bleState">æœªæ¥ç¶š</strong></span>
        <span class="chip">Spotify: <strong id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</strong></span>
        <span class="chip">Day: <strong id="dayBadge">1</strong></span>
        <span class="chip">ã‚¢ãƒ«ã‚´: <strong id="algoBadge">v1.4</strong></span>
        <span class="chip" id="esmNext">ESM: æœªäºˆå®š</span>
        <span class="chip">é¦™ã‚Š: <strong id="scentBadge">off</strong></span>
      </div>
    </div>
    <div class="row" style="gap:8px;flex:0 0 auto">
      <button id="btnBle" class="btn">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼</button>
      <button id="btnSp" class="btn">Spotify</button>
      <button id="btnStart" class="btn btn-primary">é–‹å§‹</button>
      <button id="btnPause" class="btn" disabled>ä¸€æ™‚åœæ­¢</button>
      <button id="btnStop" class="btn btn-danger" disabled>çµ‚äº†</button>
    </div>
  </div>
</div>

<div class="wrap grid">
  <div class="card">
    <div class="section-title"><h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h2></div>

    <div class="row" style="margin-bottom:10px">
      <div>
        <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æãƒ©ãƒ™ãƒ«ï¼‰</label>
        <select id="cond">
          <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
          <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
          <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
          <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
        </select>
        <div class="muted">â€» å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•åˆ¶å¾¡ã—ã¾ã™ã€‚</div>
      </div>
      <div>
        <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
        <input id="pid" placeholder="hiro" value="hiro"/>
      </div>
      <div>
        <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
        <select id="goalMin">
          <option value="90">90åˆ†</option>
          <option value="120" selected>120åˆ†</option>
          <option value="150">150åˆ†</option>
        </select>
        <div class="muted" id="goalText" style="margin-top:4px">é€²æ—: 0 / 120åˆ†</div>
        <div class="progress" aria-label="ä»Šæ—¥ã®é€²æ—"><div id="goalBar" class="bar"></div></div>
      </div>
    </div>

    <div class="row" style="align-items:center;margin-bottom:10px;gap:12px">
      <div style="max-width:260px">
        <label class="muted">å®Ÿé¨“æ—¥ï¼ˆDayï¼‰ã‚’æ‰‹å‹•ã§èª¿æ•´</label>
        <div class="row" style="gap:6px;align-items:center">
          <button id="dayMinus" class="btn">âˆ’</button>
          <input id="dayNum" type="number" min="1" value="1" style="text-align:center">
          <button id="dayPlus" class="btn">ï¼‹</button>
        </div>
      </div>
      <div class="switch">
        <input type="checkbox" id="autoStop" checked>
        <label for="autoStop">ç›®æ¨™åˆ°é”ã§è‡ªå‹•çµ‚äº†</label>
      </div>
    </div>

    <details>
      <summary class="muted tiny">Spotifyç–é€šãƒ†ã‚¹ãƒˆ</summary>
      <div class="row" style="margin-top:8px">
        <button id="btnPlayCalm" class="btn">Calmç¶­æŒã‚’å†ç”Ÿ</button>
        <button id="btnPlayTen" class="btn">ç·Šå¼µâ†’é®é™ã‚’å†ç”Ÿ</button>
        <button id="btnPlayDep" class="btn">è½ã¡è¾¼ã¿â†’ãƒªãƒ•ãƒˆ</button>
      </div>
      <div class="muted tiny">éŸ³ãŒå‡ºãªã„å ´åˆï¼šSpotifyã‚¢ãƒ—ãƒªã§1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢â†’ã“ã®ç”»é¢ã€‚</div>
    </details>

    <details>
      <summary class="muted tiny">é¦™ã‚Šãƒ†ã‚¹ãƒˆï¼ˆSwitchBot Botï¼‰</summary>
      <div class="row" style="margin-top:8px">
        <button id="btnScentTen" class="btn">ç·Šå¼µç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentCalm" class="btn">é®é™ç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentDep" class="btn">è½ã¡è¾¼ã¿ç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentOff" class="btn">ç›´è¿‘ONã®Botã‚’2å›æŠ¼ã—ï¼ˆOFFï¼‰</button>
      </div>
    </details>

    <div class="section-title" style="margin-top:10px"><h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2></div>
    <div class="row">
      <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
      <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
    </div>
    <label style="margin-top:6px;display:block">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
    <div class="row" style="margin-top:8px"><button id="btnNote" class="btn">ã‚¢ãƒ³ã‚±è¿½åŠ </button></div>
  </div>

  <div class="card">
    <div class="section-title"><h2>ãƒ­ã‚°</h2></div>
    <pre id="log" class="logbox" aria-live="polite"></pre>
    <div class="row" style="gap:8px;flex:0 0 auto;margin-top:10px">
      <button id="btnCsv" class="btn" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="btnClear" class="btn btn-ghost">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="muted tiny" style="margin-top:6px">â€»ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå¾©å…ƒå¯ï¼‰ã€‚</div>
  </div>
</div>

<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ">
  <div class="box">
    <h3 style="margin:0 0 6px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted tiny" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="row">
      <button data-esm="tense" class="btn">ç·Šå¼µ</button>
      <button data-esm="calm"  class="btn">é®é™</button>
      <button data-esm="depress" class="btn">è½ã¡è¾¼ã¿</button>
      <button data-esm="skip" class="btn">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
/* ---------- åŸºæœ¬ãƒ­ã‚°/ã‚¨ãƒ©ãƒ¼ ---------- */
function log(s){ const el=document.getElementById("log"); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; }
window.addEventListener("error",(e)=>{log(`âš ï¸ JSã‚¨ãƒ©ãƒ¼ @${e.filename||''}:${e.lineno||''}:${e.colno||''}\n${e.message}\n${e?.error?.stack||""}`);});
window.addEventListener("unhandledrejection",(e)=>{log(`âš ï¸ Promiseæœªå‡¦ç†: ${(e?.reason?.message||e?.reason||"")}\n${e?.reason?.stack||""}`);});

/* ---------- ç ”ç©¶å›ºå®š ---------- */
const ALGO_VERSION="v1.4"; document.getElementById("algoBadge").textContent=ALGO_VERSION;
const ZTH={ T_RMSSD_STRONG:-0.60, T_RMSSD_SOFT:-0.30, T_HR_HELP:0.20,
            C_RMSSD_STRONG: 0.60, C_RMSSD_SOFT: 0.30, C_HR_HELP:0.20,
            D_HR_LOW:-0.40, D_RMSSD_LOW:-0.20, D_RMSSD_HIGH:0.10 };
const VOTE_WIN=5, VOTE_NEED=3, SEG_MIN_MIN=3, WARMUP_MIN=3;
const SD_HR_FLOOR=3.0, SD_RMSSD_FLOOR=0.015;

/* ---------- Spotify ---------- */
const SPOTIFY_CLIENT_ID="7838a0cf003644ae8b5f3f75b9eb534e";
const REDIRECT_URI=location.origin+location.pathname;
const SCOPES=["user-read-playback-state","user-modify-playback-state","playlist-read-private","playlist-read-collaborative","streaming"].join(" ");
const PLAYLIST_TENSION_TO_CALM="spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT="spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN ="spotify:playlist:2m9HoHfpO0tk5eky1fopVu";

/* ---------- JSTãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */
const $=s=>document.querySelector(s);
const bleStateEl=$("#bleState"), spStateEl=$("#spState"), esmNext=$("#esmNext"), scentBadge=$("#scentBadge");
function clearLog(){ $("#log").textContent=""; }
function nowJstObj(){ return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Tokyo"})); }
function dayIsoJST(d=nowJstObj()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
function datetimeStrJST(d=nowJstObj()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"), ss=String(d.getSeconds()).padStart(2,"0");
  return `${y}-${m}-${da} ${hh}:${mi}:${ss}`;
}
function randomMinutes(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function csvEscape(v){ if(v==null) return ""; const s=String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
function getTimeBinJST(d=nowJstObj()){
  const h=d.getHours();
  if (h >= 18 && h < 22) return "evening";
  if (h >= 22 || h < 1)  return "late";
  if (h >= 1  && h < 3)  return "deep";
  if (h >= 3  && h < 6)  return "early";
  return "day";
}

/* ---------- Day/ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜ ---------- */
function toSafeDayNum(x){ const n=parseInt(x,10); return Number.isFinite(n)&&n>=1?n:1; }
function loadUser(pid){ try{const raw=localStorage.getItem(`emotion_user_${pid}`); if(!raw) return null; return JSON.parse(raw);}catch{return null;} }
function saveUser(u){ try{localStorage.setItem(`emotion_user_${u.pid}`, JSON.stringify(u));}catch{} }
function ensureUser(pid){
  let u=loadUser(pid); if(!u||typeof u!=="object"||Array.isArray(u)) u={};
  if(!u.pid) u.pid=pid;
  if(!u.daysByNum||typeof u.daysByNum!=="object"||Array.isArray(u.daysByNum)) u.daysByNum={};
  if(typeof u.total_valid!=="number"||!Number.isFinite(u.total_valid)) u.total_valid=0;
  if(typeof u.max_day_num!=="number"||!Number.isFinite(u.max_day_num)||u.max_day_num<1) u.max_day_num=1;
  saveUser(u); return u;
}
function ensureDay(u,dayNum){
  const dn=toSafeDayNum(dayNum);
  if(!u.daysByNum||typeof u.daysByNum!=="object") u.daysByNum={};
  if(!u.daysByNum[dn]||typeof u.daysByNum[dn]!=="object"||Array.isArray(u.daysByNum[dn])) u.daysByNum[dn]={ total_valid:0, sessions:[] };
  if(typeof u.max_day_num!=="number"||u.max_day_num<dn) u.max_day_num=dn;
  saveUser(u); return u.daysByNum[dn];
}
function setDayBadgeNum(n){ const x=toSafeDayNum(n); $("#dayBadge").textContent=String(x); $("#dayNum").value=String(x); }

/* ---------- æ—§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ•‘æ¸ˆ ---------- */
(function(){
  try{ const pid=($("#pid")?.value||"pid").trim(); const raw=localStorage.getItem(`emotion_user_${pid}`);
    if(!raw) return; const obj=JSON.parse(raw);
    if(!obj||typeof obj!=="object"||Array.isArray(obj)||!obj.daysByNum||typeof obj.daysByNum!=="object"||Array.isArray(obj.daysByNum)){
      const fixed={pid,daysByNum:{},total_valid:0,max_day_num:1}; localStorage.setItem(`emotion_user_${pid}`,JSON.stringify(fixed));
    }
  }catch{} })();

/* ---------- çŠ¶æ…‹ ---------- */
let hr=null, rrList=[];
let timer=null, esmTimer=null, esmDueAt=0;
let sessionId=Math.random().toString(36).slice(2,10);
let spotifyAccessToken=null, spotifyRefreshToken=null, spotifyTokenExpAt=0;
let csvRows=[[]];
let validMin=0, playMin=0, anyBLE=false, bleDropped=false, lastHadBLE=false;
let currentEmotionKey=null, waitingSwitch=false;
let votes={tension:[],calm:[],depress:[]};
let lastEmotion="unknown", lastNonUnknown="unknown", lastNonUnknownAt=0;
let startedAtMs=0;
let isPaused=false;

/* ---------- é¦™ã‚Šï¼ˆSwitchBotï¼‰ ---------- */
const SWITCHBOT_TOKEN = "3ca5812e6d4bc4a01e73bd603eb854734d2d97937e543cdf56fb1467ed4e0810a23cccfa70f26238d7d9f2ff310b940a";
const SWITCHBOT_TENSION_ID = "E16A84063A18";
const SWITCHBOT_RELAX_ID   = "E16A8386467A"; // calmç”¨ON
const SWITCHBOT_DEPRESS_ID = "D23534382415";

let scentIsOn=false;
let lastScentDeviceId="";
let lastScentOpAt=0;
const SCENT_COOLDOWN_MS = 20*1000;
function canScentOp(){ return (Date.now()-lastScentOpAt) > SCENT_COOLDOWN_MS; }

/* ãƒ—ãƒ­ã‚­ã‚·å„ªå…ˆ â†’ ç›´å©ããƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
async function switchbotPress(deviceId, times){
  try{
    const prox = await fetch("/api/switchbot-press",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId,times})});
    if(prox.ok) return;
  }catch(_){}
  for(let i=0;i<times;i++){
    const r=await fetch(`https://api.switch-bot.com/v1.1/devices/${encodeURIComponent(deviceId)}/commands`,{
      method:"POST",
      headers:{ "Authorization":SWITCHBOT_TOKEN, "Content-Type":"application/json; charset=utf8"},
      body: JSON.stringify({ command:"press", parameter:"default", commandType:"command" })
    }).catch(err=>({ok:false,statusText:String(err)}));
    if(!r || !r.ok){ log(`âš ï¸ SwitchBot presså¤±æ•— dev=${deviceId} (${r?.status||"noresp"})`); }
    await new Promise(res=>setTimeout(res, 600));
  }
}
async function scentOnFor(deviceId, label){
  if(!deviceId || !canScentOp()) return;
  lastScentOpAt=Date.now();
  try{
    await switchbotPress(deviceId, 1);
    scentIsOn=true; lastScentDeviceId=deviceId; $("#scentBadge").textContent="on";
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), toSafeDayNum($("#dayNum").value), getTimeBinJST(),
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "scent_on",label,
      "", "", ALGO_VERSION
    ]);
    log(`ğŸŒ«ï¸ é¦™ã‚Š ONï¼ˆ${label}ï¼š1å›æŠ¼ã—ï¼‰`);
  }catch(e){ log("âš ï¸ scentOnå¤±æ•—: "+e.message); }
}
async function scentOffCurrent(){
  if(!scentIsOn || !lastScentDeviceId || !canScentOp()) return;
  lastScentOpAt=Date.now();
  try{
    await switchbotPress(lastScentDeviceId, 2);
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), toSafeDayNum($("#dayNum").value), getTimeBinJST(),
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "scent_off",lastScentDeviceId,
      "", "", ALGO_VERSION
    ]);
    log(`ğŸŒ«ï¸ é¦™ã‚Š OFFï¼ˆdev=${lastScentDeviceId}ï¼š2å›æŠ¼ã—ï¼‰`);
  }catch(e){ log("âš ï¸ scentOffå¤±æ•—: "+e.message); }
  scentIsOn=false; lastScentDeviceId=""; $("#scentBadge").textContent="off";
}
function deviceForEmotion(emotion){
  if(emotion==="tension") return [SWITCHBOT_TENSION_ID,"tension"];
  if(emotion==="depress") return [SWITCHBOT_DEPRESS_ID,"depress"];
  if(emotion==="calm")    return [SWITCHBOT_RELAX_ID,"calm"];
  return [null,null];
}
async function handleScentForEmotion(emotion, condition, exercise){
  if(!(condition==="SCENT"||condition==="BOTH")) return;
  if(exercise) return;
  if(Date.now()-startedAtMs < WARMUP_MIN*60*1000) return;

  const [targetDev, label] = deviceForEmotion(emotion);

  if(targetDev){
    if(scentIsOn && lastScentDeviceId && lastScentDeviceId!==targetDev){
      await scentOffCurrent(); await scentOnFor(targetDev, label);
    }else if(!scentIsOn){
      await scentOnFor(targetDev, label);
    }
  }else{
    if(scentIsOn){ await scentOffCurrent(); }
  }
}

/* ---------- AutoSave ---------- */
const LS_KEY="emotion_recorder_autosave_v7_calmScent_nodouble_fixcss";
function saveState(){
  try{
    const payload={
      csvRows, sessionId, validMin, playMin, anyBLE, bleDropped, lastHadBLE,
      currentEmotionKey, waitingSwitch, votes, lastEmotion, lastNonUnknown,
      lastNonUnknownAt, startedAtMs, esmDueAt,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      pid:($("#pid").value||"pid"), condition:$("#cond").value, goal:$("#goalMin").value,
      dayNum: toSafeDayNum($("#dayNum").value), algo: ALGO_VERSION, isPaused,
      scentIsOn, lastScentDeviceId, lastScentOpAt
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }catch{}
}
function loadStateIfAny(){
  try{
    const s=localStorage.getItem(LS_KEY); if(!s) return false;
    const p=JSON.parse(s);
    csvRows=p.csvRows||[[]]; sessionId=p.sessionId||sessionId; validMin=p.validMin||0; playMin=p.playMin||0;
    anyBLE=!!p.anyBLE; bleDropped=!!p.bleDropped; lastHadBLE=!!p.lastHadBLE;
    currentEmotionKey=p.currentEmotionKey||null; waitingSwitch=!!p.waitingSwitch;
    votes=(p.votes&&typeof p.votes==="object")?p.votes:{tension:[],calm:[],depress:[]};
    ["tension","calm","depress"].forEach(k=>{ if(!Array.isArray(votes[k])) votes[k]=[]; if(votes[k].length>VOTE_WIN) votes[k]=votes[k].slice(-VOTE_WIN); });
    lastEmotion=p.lastEmotion||"unknown"; lastNonUnknown=p.lastNonUnknown||"unknown"; lastNonUnknownAt=p.lastNonUnknownAt||0;
    startedAtMs=p.startedAtMs||Date.now(); esmDueAt=p.esmDueAt||0;
    hr_base=p.hr_base??hr_base; rmssd_base=p.rmssd_base??rmssd_base; sd_hr=p.sd_hr??sd_hr; sd_rmssd=p.sd_rmssd??sd_rmssd;
    if(p.pid) $("#pid").value=p.pid; if(p.condition) $("#cond").value=p.condition; if(p.goal) $("#goalMin").value=p.goal;
    if(p.dayNum){ setDayBadgeNum(p.dayNum); }
    isPaused=!!p.isPaused; $("#btnPause").textContent=isPaused?"å†é–‹":"ä¸€æ™‚åœæ­¢";
    scentIsOn=!!p.scentIsOn; lastScentDeviceId=p.lastScentDeviceId||""; lastScentOpAt=p.lastScentOpAt||0;
    $("#scentBadge").textContent = scentIsOn ? "on" : "off";
    return true;
  }catch{ return false; }
}
function clearSavedState(){ localStorage.removeItem(LS_KEY); }

/* ---------- HRV ---------- */
function calcRMSSD(rrs){
  const xs=rrs.filter(x=>x>=0.3 && x<=2.0);
  if(xs.length<3) return null;
  let sum=0,n=0; for(let i=1;i<xs.length;i++){ const d=xs[i]-xs[i-1]; sum+=d*d; n++; }
  return Math.sqrt(sum/n);
}

/* ---------- BLE ---------- */
async function connectBLE(){
  try{
    log("ğŸ©º BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["heart_rate"]});
    const server=await dev.gatt.connect();
    const svc=await server.getPrimaryService("heart_rate");
    const ch=await svc.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged",(e)=>{
      try{
        const raw=e?.target?.value; let v=null;
        if(raw instanceof DataView){ v=raw; }
        else if(raw?.buffer instanceof ArrayBuffer){ v=new DataView(raw.buffer, raw.byteOffset||0, raw.byteLength||raw.buffer.byteLength); }
        else if(raw instanceof ArrayBuffer){ v=new DataView(raw); }
        if(!(v instanceof DataView)||v.byteLength<2){ log("âš ï¸ BLE: short/unknown packet dropped"); return; }
        const flags=v.getUint8(0); const is16=(flags&0x01)!==0; const hasRR=(flags&0x10)!==0;
        if(is16){ if(v.byteLength>=3) hr=v.getUint16(1,true); else return; } else { hr=v.getUint8(1); }
        anyBLE=true; lastHadBLE=true;
        const rrLocal=[];
        if(hasRR){ let idx=is16?3:2; while(idx+1<v.byteLength){ const rrSec=v.getUint16(idx,true)/1024.0; if(rrSec>=0.3&&rrSec<=2.0) rrLocal.push(rrSec); idx+=2; } }
        if(rrLocal.length){ rrList.push(...rrLocal); if(rrList.length>60) rrList=rrList.slice(-60); }
        bleStateEl.textContent=`æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
      }catch(err){ log("âš ï¸ BLE parse error: "+(err?.message||err)); }
    });
    dev.addEventListener("gattserverdisconnected",()=>{ bleStateEl.textContent="åˆ‡æ–­"; if(lastHadBLE) bleDropped=true; lastHadBLE=false; });
    bleStateEl.textContent="æ¥ç¶šå®Œäº†"; log("âœ… BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){ bleStateEl.textContent="æœªæ¥ç¶š"; log("âš ï¸ BLE error: "+err.message); }
}

/* ---------- Spotifyï¼ˆPKCEï¼‰ ---------- */
function base64url(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
async function pkce(){ const ver=base64url(crypto.getRandomValues(new Uint8Array(32))); const dig=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver)); const chal=base64url(dig); sessionStorage.setItem("pkce_verifier",ver); return chal; }
async function loginSpotify(){
  const code=new URLSearchParams(location.search).get("code");
  if(!code){
    const challenge=await pkce();
    location.href="https://accounts.spotify.com/authorize?"+new URLSearchParams({client_id:SPOTIFY_CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:"S256",code_challenge:challenge});
    return;
  }
  const ver=sessionStorage.getItem("pkce_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:SPOTIFY_CLIENT_ID,code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const t=await r.json();
  if(t.access_token){ spotifyAccessToken=t.access_token; spotifyRefreshToken=t.refresh_token||null; spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000);
    spStateEl.textContent="ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿"; log("âœ… Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"); history.replaceState({}, "", REDIRECT_URI);
  }else{ log("âš ï¸ Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(t)); }
}
async function refreshSpotifyIfNeeded(){
  if(!spotifyRefreshToken) return;
  if(Date.now()<spotifyTokenExpAt-30000) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:spotifyRefreshToken,client_id:SPOTIFY_CLIENT_ID});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const t=await r.json(); if(t.access_token){ spotifyAccessToken=t.access_token; spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000); log("ğŸ”„ Spotify: ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°"); }
}
async function spRequest(method,url,body){ await refreshSpotifyIfNeeded(); if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url,{method,headers:{"Authorization":"Bearer "+spotifyAccessToken,"Content-Type":"application/json"},body:body?JSON.stringify(body):undefined});
}
async function getDevices(){ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/devices"); const js=await r.json().catch(()=>({devices:[]}));
  const devs=js.devices||[]; log("ğŸ§ Devices: "+(devs.map(d=>`${d.name}${d.is_active?'(active)':''}`).join(", ")||"none")); return devs; }
async function ensureActiveDevice(){
  const devs=await getDevices(); if(devs.length===0){ log("âš ï¸ å†ç”Ÿç«¯æœ«ãªã—ï¼šSpotifyã‚¢ãƒ—ãƒªã§1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢â†’ã“ã®ç”»é¢ã¸"); return null; }
  const active=devs.find(d=>d.is_active)||devs[0];
  try{ await spRequest("PUT","https://api.spotify.com/v1/me/player",{device_ids:[active.id],play:false}); }catch(e){ log("transfer err: "+e.message); }
  return active.id;
}
async function ensureShuffleOn(){ try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }catch(e){} }
async function getCurrentPlaying(){ try{ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing"); if(r.status===204) return null; return await r.json(); }catch(_){ return null; } }
function extractTrackInfo(j){
  try{
    if(!j||!j.is_playing||!j.item) return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};
    const a=(j.item.artists||[]).map(x=>x.name).join(", "); const ctx=(j.context&&j.context.uri)?j.context.uri:"";
    return {track_id:j.item.id||"",track_name:j.item.name||"",artists:a,context_uri:ctx,duration_ms:j.item.duration_ms||0,progress_ms:j.progress_ms||0,is_playing:!!j.is_playing};
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,is_playing:false,progress_ms:0}; }
}
async function bootAndPlay(uri){
  const dev=await ensureActiveDevice(); if(!dev) return false;
  await ensureShuffleOn();
  let r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0});
  if(!r.ok){
    try{ await spRequest("POST","https://api.spotify.com/v1/me/player/next?device_id="+encodeURIComponent(dev)); }catch(_){}
    r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0});
    if(!r.ok){ log("âš ï¸ playå¤±æ•—: "+(await r.text()).slice(0,160)); return false; }
  }
  return true;
}
async function playPlaylist(uri){ const ok=await bootAndPlay(uri); if(!ok) log("âš ï¸ å†ç”Ÿã§ãã¾ã›ã‚“ï¼ˆç«¯æœ«/åºƒå‘Š/æ¨©é™ï¼‰"); }

/* ---------- æ›²æœ«ã§åˆ‡æ›¿ ---------- */
let waitingSwitch=false, currentEmotionKey=null;
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey || waitingSwitch) return;
  waitingSwitch=true;
  const uri = targetKey==="tension"?PLAYLIST_TENSION_TO_CALM:
              targetKey==="depress"?PLAYLIST_DEPRESS_TO_LIFT:PLAYLIST_CALM_MAINTAIN;
  const deadline=Date.now()+5*60*1000; let allow=false;
  while(Date.now()<deadline){
    const info=extractTrackInfo(await getCurrentPlaying());
    if(!info.is_playing||!info.duration_ms) break;
    const remain=Math.max(0, info.duration_ms-(info.progress_ms||0));
    if(remain<=3500){ allow=true; break; }
    await new Promise(r=>setTimeout(r,1200));
  }
  if(allow){ await playPlaylist(uri); currentEmotionKey=targetKey; log(`ğŸµ Playlist â†’ ${targetKey}`); }
  else{ log("ğŸµ Switch skipped (no end-of-track within 5min)"); }
  waitingSwitch=false;
}

/* ---------- åˆ¤å®š ---------- */
function pushVote(key, ok){ const a=votes[key]; a.push(ok?1:0); if(a.length>VOTE_WIN) a.shift(); return a.reduce((x,y)=>x+y,0)>=VOTE_NEED; }
function decideEmotion(hrValue, rmssd, z_hr, z_rmssd){
  if(rmssd==null || z_hr==="" || z_rmssd==="") return "unknown";
  if(Date.now()-startedAtMs >= WARMUP_MIN*60*1000){
    if(lastNonUnknown!=="unknown" && (Date.now()-lastNonUnknownAt)<SEG_MIN_MIN*60*1000) return lastNonUnknown;
  }
  const candT = (z_rmssd<=ZTH.T_RMSSD_STRONG) || (z_rmssd<=ZTH.T_RMSSD_SOFT && z_hr>=ZTH.T_HR_HELP);
  const candC = (z_rmssd>=ZTH.C_RMSSD_STRONG) || (z_rmssd>=ZTH.C_RMSSD_SOFT && z_hr<=ZTH.C_HR_HELP);
  const candD = (z_hr<=ZTH.D_HR_LOW && z_rmssd>=ZTH.D_RMSSD_LOW && z_rmssd<=ZTH.D_RMSSD_HIGH);
  const okC=pushVote("calm",candC), okT=pushVote("tension",candT), okD=pushVote("depress",candD);
  let decided="unknown"; if(okC) decided="calm"; else if(okT) decided="tension"; else if(okD) decided="depress";
  if(decided!=="unknown" && (Date.now()-startedAtMs)>=WARMUP_MIN*60*1000){ lastNonUnknown=decided; lastNonUnknownAt=Date.now(); }
  lastEmotion=decided; return decided;
}

/* ---------- ESM ---------- */
function scheduleNextESM(){
  clearTimeout(esmTimer);
  const m=randomMinutes(28,34);
  esmDueAt=Date.now()+m*60*1000;
  const j=nowJstObj(); j.setTime(esmDueAt);
  const hh=String(j.getHours()).padStart(2,"0")+":"+String(j.getMinutes()).padStart(2,"0");
  esmNext.textContent=`ESM: ${hh}é ƒ`;
  esmTimer=setTimeout(()=>{
    if(isPaused){ scheduleNextESM(); return; }
    document.getElementById("esmModal").style.display="flex";
  }, m*60*1000);
}
const esmModal=document.getElementById("esmModal");
esmModal.addEventListener("click",(e)=>{ if(e.target===esmModal) esmModal.style.display="none"; });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ esmModal.style.display="none"; } });
document.querySelectorAll("#esmModal button[data-esm]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const val=btn.getAttribute("data-esm");
    csvRows.push([
      Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), toSafeDayNum($("#dayNum").value), getTimeBinJST(),
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "esm",val,
      "","", ALGO_VERSION
    ]);
    log(`ğŸ—³ï¸ ESM: ${val}`); esmModal.style.display="none"; scheduleNextESM(); saveState();
  });
});

/* ---------- ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ ---------- */
let prevHR=null, prevRMSSD=null;
let hr_base=70, sd_hr=8, rmssd_base=0.04, sd_rmssd=0.018;
const EWMA=0.05;

/* ---------- CSV ãƒ˜ãƒƒãƒ€ ---------- */
function makeHeader(){
  csvRows=[[ "timestamp","datetime_jst","pid","day_local","day_iso_jst","day_num","time_bin",
    "session_id","block","condition",
    "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
    "roll_std_h","roll_std_rr","emotion",
    "track_id","track_name","artists","context_uri",
    "hr_base","rmssd_base","sd_hr","sd_rmssd",
    "is_playing","exercise","valid_for_rank",
    "valid_for_rank_none","valid_for_rank_music","valid_for_rank_both",
    "mood","relax","note","event","esm",
    "session_minutes_valid","reason_invalid","algo_version"
  ]];
}

/* ---------- 1åˆ†åˆ»ã¿ ---------- */
function updateGoalView(goal){
  const g=goal?goal:parseInt($("#goalMin").value||"120",10);
  $("#goalText").textContent=`é€²æ—: ${validMin} / ${g}åˆ†`;
  const p=Math.max(0,Math.min(100, (validMin/g)*100 ));
  $("#goalBar").style.width=p+"%";
  $("#goalBar").style.background= (validMin>=g) ? "linear-gradient(90deg,#16a34a,#22c55e)" : "linear-gradient(90deg,#60a5fa,#22d3ee)";
}
async function oneTick(){
  try{
    if(isPaused){ log("â›³ ä¸€æ™‚åœæ­¢ä¸­"); saveState(); return; }
    const pid=($("#pid").value||"").trim()||"pid";
    const condition=$("#cond").value;
    const goal=parseInt($("#goalMin").value||"120",10);
    const dayNum=toSafeDayNum($("#dayNum").value);

    const rmssd=calcRMSSD(rrList.slice(-10));
    const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
    const z_hr     = (hr!=null) ? (hr-hr_base)/sd_hr : "";
    const z_rmssd  = (rmssd!=null) ? (rmssd-rmssd_base)/sd_rmssd : "";
    const d_hr     = (prevHR!=null && hr!=null) ? (hr-prevHR) : "";
    const d_rmssd  = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD) : "";
    const emotion  = decideEmotion(hr, rmssd, z_hr, z_rmssd);

    let playing=false, info={track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false};
    try{ info=extractTrackInfo(await getCurrentPlaying()); playing=!!info.is_playing; }catch{}

    const exercise = (hr!=null && hr_base!=null && hr >= hr_base+25) ? 1 : 0;

    const valid_for_rank = (condition==="NONE" && playing && !exercise) ? 1 : 0;
    const valid_for_rank_none  = (condition==="NONE"  && !exercise) ? 1 : 0;
    const valid_for_rank_music = (condition==="MUSIC" && playing && !exercise) ? 1 : 0;
    const valid_for_rank_both  = (condition==="BOTH"  && playing && !exercise) ? 1 : 0;

    const gotHR=(hr!=null);
    if(gotHR){
      if(condition==="MUSIC"||condition==="BOTH"){ if(playing){ validMin++; playMin++; } }
      else{ validMin++; }
    }

    // Spotify keep-alive
    if((condition==="MUSIC"||condition==="BOTH") && !exercise){
      const j = await getCurrentPlaying().catch(()=>null);
      const info2 = extractTrackInfo(j);
      if(!info2.is_playing){ log("ğŸ§ keep-alive: å†ç”Ÿèµ·å‹•ã‚’è©¦è¡Œ"); await playPlaylist(PLAYLIST_CALM_MAINTAIN); }
    }

    updateGoalView(goal);

    // éŸ³æ¥½
    if((condition==="MUSIC"||condition==="BOTH") && !exercise){
      const key = emotion==="tension"?"tension":(emotion==="calm"?"calm":(emotion==="depress"?"depress":null));
      if(key) scheduleSwitchIfNeeded(key);
    }

    // é¦™ã‚Š
    await handleScentForEmotion(emotion, condition, exercise);

    // CSV 1åˆ†è¡Œ
    csvRows.push([
      Date.now(), datetimeStrJST(), pid,
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), dayNum, getTimeBinJST(),
      sessionId,"block1", condition,
      hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
      "", "", emotion,
      info.track_id, info.track_name, info.artists, info.context_uri,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      playing?1:0, exercise, valid_for_rank,
      valid_for_rank_none, valid_for_rank_music, valid_for_rank_both,
      "", "", "", "", "",
      "", "", ALGO_VERSION
    ]);

    // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°
    if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
      hr_base=(1-EWMA)*hr_base + EWMA*hr;
      rmssd_base=(1-EWMA)*rmssd_base + EWMA*rmssd;
      sd_hr=Math.max(SD_HR_FLOOR, (1-EWMA)*sd_hr + EWMA*Math.abs(hr-hr_base));
      sd_rmssd=Math.max(SD_RMSSD_FLOOR, (1-EWMA)*sd_rmssd + EWMA*Math.abs(rmssd-rmssd_base));
    }

    prevHR=hr; prevRMSSD=rmssd;

    try{
      const u=ensureUser(pid); const d=ensureDay(u, dayNum);
      d.total_valid=validMin; saveUser(u); setDayBadgeNum(dayNum);
    }catch{}

    log(`[tick JST] HR=${hr??"-"} playing=${playing?1:0} ex=${exercise} emotion=${emotion} scent=${scentIsOn?'on':'off'} validMin=${validMin}`);

    if(!isPaused && $("#autoStop").checked && validMin>=goal){ log("â± ç›®æ¨™åˆ°é”â†’è‡ªå‹•çµ‚äº†"); stopSession(); return; }

    saveState();
  }catch(e){
    log("âš ï¸ oneTickå¤±æ•—: " + (e?.message||e));
  }
}
function startTicking(){ if(timer) clearInterval(timer); timer=setInterval(oneTick, 60*1000); }

/* ---------- UI/ã‚»ãƒƒã‚·ãƒ§ãƒ³ ---------- */
function makeButtonsState(running){
  document.getElementById("btnStart").disabled = running;
  document.getElementById("btnPause").disabled = !running;
  document.getElementById("btnStop").disabled  = !running;
  document.getElementById("btnCsv").disabled   = running;
  document.getElementById("btnBle").disabled   = false;
  document.getElementById("btnSp").disabled    = false;
  document.getElementById("dayMinus").disabled = false;
  document.getElementById("dayPlus").disabled  = false;
  document.getElementById("dayNum").disabled   = false;
}
function makeHeaderAndReset(){
  makeHeader();
  sessionId=Math.random().toString(36).slice(2,10);
  validMin=0; playMin=0; anyBLE=false; bleDropped=false; lastHadBLE=false;
  currentEmotionKey=null; waitingSwitch=false;
  votes={tension:[],calm:[],depress:[]}; lastEmotion="unknown"; lastNonUnknown="unknown"; lastNonUnknownAt=0;
  startedAtMs=Date.now(); isPaused=false; $("#btnPause").textContent="ä¸€æ™‚åœæ­¢";
  scentIsOn=false; lastScentDeviceId=""; lastScentOpAt=0; $("#scentBadge").textContent="off";
}
function startSession(){
  try{
    const pid=($("#pid").value||"pid").trim();
    const dayNum=toSafeDayNum($("#dayNum").value);
    const u=ensureUser(pid); ensureDay(u, dayNum); setDayBadgeNum(dayNum);

    makeButtonsState(true);
    makeHeaderAndReset();
    updateGoalView();
    log("â–¶ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
    scheduleNextESM();

    if($("#cond").value==="MUSIC"||$("#cond").value==="BOTH"){
      playPlaylist(PLAYLIST_CALM_MAINTAIN).catch(e=>log("Spotifyèµ·å‹•å¤±æ•—: "+e.message));
    }

    oneTick().catch(e=>log("oneTickåˆå›ã‚¨ãƒ©ãƒ¼: "+(e?.message||e)));
    startTicking();
    saveState();
  }catch(e){
    log("âš ï¸ startSessionã§ä¾‹å¤–: "+(e?.message||e));
  }
}
function stopSession(){
  clearInterval(timer); timer=null; clearTimeout(esmTimer); esmTimer=null; esmNext.textContent="ESM: æœªäºˆå®š";
  makeButtonsState(false);

  const condition=$("#cond").value, dayNum=toSafeDayNum($("#dayNum").value);
  let reasons=[]; if(validMin<60) reasons.push("<60min");
  if((condition==="MUSIC"||condition==="BOTH") && playMin<30) reasons.push("playing<30");
  if(bleDropped) reasons.push("ble_drop");
  const reason_invalid=reasons.join("+")||"";

  if (!Array.isArray(csvRows) || csvRows.length === 0) {
    makeHeader();
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(),
      dayNum, getTimeBinJST(), sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "init","", "", "", ALGO_VERSION
    ]);
  }

  if(csvRows.length>1){
    const last=csvRows[csvRows.length-1];
    last[last.length-3]=String(validMin);
    last[last.length-2]=reason_invalid;
  }else{
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), dayNum, getTimeBinJST(),
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "end","",
      String(validMin), reason_invalid, ALGO_VERSION
    ]);
  }

  try{
    const pid=($("#pid").value||"pid").trim(); const u=ensureUser(pid); const d=ensureDay(u, dayNum);
    d.total_valid += validMin;
    d.sessions.push({session_id:sessionId,condition,day_num:dayNum,minutes:validMin,play_minutes:playMin,reason_invalid,
                     started_at_jst:datetimeStrJST(new Date(startedAtMs)), ended_at_jst:datetimeStrJST()});
    u.total_valid += validMin; saveUser(u); setDayBadgeNum(dayNum);
  }catch{}

  clearSavedState();
  isPaused=false; $("#btnPause").textContent="ä¸€æ™‚åœæ­¢";
  log(`â–  ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†, ç†ç”±=${reason_invalid||"ãªã—"}ï¼‰`);
}

/* ---------- ã‚¢ãƒ³ã‚±/CSV ---------- */
document.getElementById("btnNote").onclick=()=>{ const mood=$("#mood").value||"", relax=$("#relax").value||"", notes=$("#notes").value||"";
  if(csvRows.length>1){ const im=csvRows[0].indexOf("mood"), ir=csvRows[0].indexOf("relax"), inx=csvRows[0].indexOf("note");
    const last=csvRows[csvRows.length-1]; last[im]=mood; last[ir]=relax; last[inx]=notes; }
  log("ğŸ“ ã‚¢ãƒ³ã‚±è¿½åŠ "); saveState(); };

document.getElementById("btnCsv").onclick=()=>{ const lines=csvRows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const blob=new Blob([lines],{type:"text/csv"});
  const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:`emotion_log_${dayIsoJST()}_${sessionId}.csv`});
  a.click(); URL.revokeObjectURL(a.href); };

/* ---------- ãƒãƒ³ãƒ‰ãƒ©é‡è¤‡ç¦æ­¢ ---------- */
let __handlersBound=false;
function bindCoreHandlers(){
  if(__handlersBound) return; __handlersBound=true;

  const byId=id=>document.getElementById(id);

  byId("btnBle").onclick = connectBLE;
  byId("btnSp").onclick  = loginSpotify;
  byId("btnStart").onclick = startSession;
  byId("btnStop").onclick  = stopSession;
  byId("btnPause").onclick = ()=>{
    isPaused=!isPaused;
    byId("btnPause").textContent=isPaused?"å†é–‹":"ä¸€æ™‚åœæ­¢";
    log(isPaused?"â›” ä¸€æ™‚åœæ­¢":"â–¶ å†é–‹");
    saveState();
  };
  byId("btnClear").onclick = clearLog;

  byId("dayMinus").onclick = ()=>{ const n=toSafeDayNum(byId("dayNum").value)-1; setDayBadgeNum(Math.max(1,n)); saveState(); };
  byId("dayPlus").onclick  = ()=>{ const n=toSafeDayNum(byId("dayNum").value)+1; setDayBadgeNum(n); saveState(); };
  byId("dayNum").onchange  = ()=>{ setDayBadgeNum(toSafeDayNum(byId("dayNum").value)); saveState(); };

  byId("btnPlayCalm").onclick = ()=>playPlaylist(PLAYLIST_CALM_MAINTAIN);
  byId("btnPlayTen").onclick  = ()=>playPlaylist(PLAYLIST_TENSION_TO_CALM);
  byId("btnPlayDep").onclick  = ()=>playPlaylist(PLAYLIST_DEPRESS_TO_LIFT);

  byId("btnScentTen").onclick = async ()=>{ await scentOnFor(SWITCHBOT_TENSION_ID,"tension-test"); };
  byId("btnScentCalm").onclick= async ()=>{ await scentOnFor(SWITCHBOT_RELAX_ID,"calm-test"); };
  byId("btnScentDep").onclick = async ()=>{ await scentOnFor(SWITCHBOT_DEPRESS_ID,"depress-test"); };
  byId("btnScentOff").onclick = async ()=>{ await scentOffCurrent(); };
}
document.addEventListener("DOMContentLoaded", bindCoreHandlers);

/* ---------- èµ·å‹•æ™‚ã®å¾©å…ƒ ---------- */
if(new URLSearchParams(location.search).get("code")) loginSpotify();
if(loadStateIfAny()){
  const pid=($("#pid").value||"pid").trim(); ensureUser(pid); setDayBadgeNum(toSafeDayNum($("#dayNum").value));
  const g=parseInt($("#goalMin").value||"120",10); updateGoalView(g);
  log("ğŸ§© é€”ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  if(esmDueAt>0){ const j=nowJstObj(); j.setTime(esmDueAt); const hh=String(j.getHours()).padStart(2,"0")+":"+String(j.getMinutes()).padStart(2,"0"); esmNext.textContent=`ESM: ${hh}é ƒ`; }
  startTicking();
}

/* ---------- é›¢è„±è­¦å‘Š ---------- */
window.addEventListener("beforeunload",(e)=>{
  const running=!document.getElementById("btnStop").disabled, hasRows=(csvRows && csvRows.length > 1);
  if(running || hasRows){ e.preventDefault(); e.returnValue=""; }
});
</script>
</body>
</html>
