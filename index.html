<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root{ color-scheme:light dark; --bg:#121212; --panel:#1a1a1a; --line:#2a2a2a; --muted:#a9b0b8; --txt:#f3f5f7;
         --accent:#5ac8fa; --ok:#27c052; --warn:#f5a524; --danger:#ff4d4f; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--txt);
       max-width:1080px;margin:16px auto;padding:0 14px}
  h1{margin:8px 0 12px}
  .grid{display:grid;gap:12px}
  @media (min-width:920px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.18)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > * { flex:1 1 0 }
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#1f1f1f;color:var(--txt);cursor:pointer}
  .btn:hover:not(:disabled){ background:#252525 }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .btn-danger{ background:#2a1516;border-color:#4d1f21 }
  .btn-danger:hover{ background:#3a1c1e }
  .btn-ghost{ background:transparent }
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;background:#161616;padding:6px 10px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:8px;background:#151515;padding:4px 8px;font-size:13px}
  .muted{color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#141414;color:var(--txt)}
  .logbox{white-space:pre-wrap;height:240px;overflow:auto;background:#0f0f0f;color:#e8e8e8;border:1px solid var(--line);
          border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace}
  .progress{height:12px;background:#0e0e0e;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #3870ff, #50e3c2)}
  .tiny{font-size:12px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .switches{display:flex;gap:8px;flex-wrap:wrap}
  .switches .pill{cursor:pointer}
  .colfit{flex:0 0 auto}
</style>
</head>
<body>
<h1>Emotion Record</h1>

<div class="grid">
  <!-- å·¦ï¼šçŠ¶æ…‹ï¼†æ“ä½œ -->
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="chips">
        <span class="badge">BLE: <strong id="bleState">æœªæ¥ç¶š</strong></span>
        <span class="badge">Spotify: <strong id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</strong></span>
        <span class="badge">Day: <strong id="dayBadge">1</strong></span>
        <span class="badge">ã‚¢ãƒ«ã‚´: <strong id="algoBadge">v1.3</strong></span>
      </div>
      <span id="esmNext" class="badge muted">ESM: æœªäºˆå®š</span>
    </div>

    <div class="row" style="margin:10px 0">
      <button id="btnBle" class="btn">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶š</button>
      <button id="btnSp" class="btn">Spotifyãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnStart" class="btn">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
      <button id="btnStop" class="btn btn-danger" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</button>
      <button id="btnPause" class="btn btn-ghost" disabled>ä¸€æ™‚åœæ­¢</button>
      <button id="btnResume" class="btn" disabled>å†é–‹</button>
    </div>

    <div class="row" style="margin:10px 0">
      <div>
        <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æãƒ©ãƒ™ãƒ«ï¼‰</label>
        <select id="cond">
          <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
          <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
          <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
          <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
        </select>
        <div class="tiny muted" style="margin-top:4px">â€» å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•åˆ¶å¾¡ã€‚</div>
      </div>
      <div>
        <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
        <input id="pid" placeholder="hiro" value="hiro"/>
      </div>
      <div>
        <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
        <select id="goalMin">
          <option value="90">90åˆ†</option>
          <option value="120" selected>120åˆ†</option>
          <option value="150">150åˆ†</option>
        </select>
        <div id="goalText" class="tiny muted" style="margin-top:4px">é€²æ—: 0 / 120åˆ†</div>
        <div class="progress" aria-label="ä»Šæ—¥ã®é€²æ—"><div id="goalBar" class="bar"></div></div>
      </div>
    </div>

    <!-- Day æ‰‹å‹•é¸æŠ -->
    <div class="row" style="margin:6px 0">
      <div class="colfit">
        <label class="tiny muted">å®Ÿé¨“æ—¥ï¼ˆDayï¼‰</label>
        <div class="row" style="gap:6px;align-items:center">
          <button id="dayMinus" class="btn colfit">âˆ’</button>
          <input id="dayNum" type="number" min="1" value="1" class="colfit" style="width:92px;text-align:center">
          <button id="dayPlus" class="btn colfit">ï¼‹</button>
        </div>
      </div>
      <div class="switches" style="align-items:center">
        <label class="pill"><input type="checkbox" id="autoStop" checked> ç›®æ¨™åˆ°é”ã§è‡ªå‹•çµ‚äº†</label>
        <label class="pill"><input type="checkbox" id="weeklyMode"> é€±åˆè¨ˆã§ç®¡ç†ï¼ˆä¾‹: 480åˆ†/é€±ï¼‰</label>
      </div>
    </div>

    <div id="weeklyBox" class="row" style="display:none;margin-top:8px">
      <div>
        <label>ä»Šé€±ã®ç›®æ¨™åˆè¨ˆï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="weeklyGoal" value="480" min="60" step="30">
      </div>
      <div>
        <label>ä»Šé€±ã®å–å¾—</label>
        <div id="weeklyProg" class="pill">0 åˆ†</div>
      </div>
    </div>

    <details style="margin-top:6px">
      <summary class="tiny">ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰Spotifyç–é€šãƒ†ã‚¹ãƒˆ</summary>
      <div class="row" style="margin-top:8px">
        <button id="btnPlayCalm" class="btn">Calmç¶­æŒã‚’å†ç”Ÿ</button>
        <button id="btnPlayTen"  class="btn">ç·Šå¼µâ†’é®é™ã‚’å†ç”Ÿ</button>
        <button id="btnPlayDep"  class="btn">è½ã¡è¾¼ã¿â†’ãƒªãƒ•ãƒˆ</button>
      </div>
      <div class="tiny muted">éŸ³ãŒå‡ºãªã„æ™‚ï¼šSpotifyã‚¢ãƒ—ãƒªã‚’å‰é¢ã§1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢â†’ã“ã®ç”»é¢ã€‚</div>
    </details>
  </div>

  <!-- å³ï¼šãƒ­ã‚°/CSV/ã‚¢ãƒ³ã‚± -->
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2 style="margin:0">ãƒ­ã‚°</h2>
      <div class="row" style="gap:8px;flex:0 0 auto">
        <button id="btnCsv" class="btn" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="btnClear" class="btn btn-ghost">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <pre id="log" class="logbox" aria-live="polite"></pre>

    <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
    <h3 style="margin:0 0 8px">å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
    <div class="row">
      <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
      <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
    </div>
    <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="btnNote" class="btn">ã‚¢ãƒ³ã‚±è¿½åŠ </button>
    </div>
  </div>
</div>

<!-- ESM ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:9999">
  <div class="box" style="background:#171717;border:1px solid #333;border-radius:14px;padding:18px;max-width:460px;width:92%">
    <h3 style="margin:0 0 8px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted tiny" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="row">
      <button data-esm="tense" class="btn">ç·Šå¼µï¼ˆé«˜ã¶ã‚Šï¼‰</button>
      <button data-esm="calm"  class="btn">é®é™ï¼ˆè½ã¡ç€ãï¼‰</button>
      <button data-esm="depress" class="btn">è½ã¡è¾¼ã¿</button>
      <button data-esm="skip" class="btn btn-ghost">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
/* =========== ç ”ç©¶å›ºå®šï¼šã‚¢ãƒ«ã‚´/ã—ãã„å€¤ =========== */
const ALGO_VERSION="v1.3"; document.getElementById("algoBadge").textContent=ALGO_VERSION;
const ZTH={ T_RMSSD_STRONG:-0.60, T_RMSSD_SOFT:-0.30, T_HR_HELP:0.20,
            C_RMSSD_STRONG: 0.60, C_RMSSD_SOFT: 0.30, C_HR_HELP:0.20,
            D_HR_LOW:-0.40, D_RMSSD_LOW:-0.20, D_RMSSD_HIGH:0.10 };
const VOTE_WIN=5, VOTE_NEED=3, SEG_MIN_MIN=3, WARMUP_MIN=3;
const SD_HR_FLOOR=3.0, SD_RMSSD_FLOOR=0.015;

/* =========== Spotify/ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ =========== */
const SPOTIFY_CLIENT_ID="7838a0cf003644ae8b5f3f75b9eb534e";
const REDIRECT_URI=location.origin+location.pathname;
const SCOPES=["user-read-playback-state","user-modify-playback-state","playlist-read-private","playlist-read-collaborative","streaming"].join(" ");
const PLAYLIST_TENSION_TO_CALM="spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT="spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN ="spotify:playlist:2m9HoHfpO0tk5eky1fopVu";

/* =========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆJSTå›ºå®šï¼‰ =========== */
const $=s=>document.querySelector(s);
const logEl=$("#log"), bleStateEl=$("#bleState"), spStateEl=$("#spState"), esmNext=$("#esmNext");
function log(s){ logEl.textContent+=s+"\n"; logEl.scrollTop=logEl.scrollHeight; }
function clearLog(){ logEl.textContent=""; }
const JST_FMT_DATE = new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit"});
const JST_FMT_DATETIME = new Intl.DateTimeFormat("ja-JP",{timeZone:"Asia/Tokyo",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
function nowJstObj(){ return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Tokyo"})); }
function dayIsoJST(d=nowJstObj()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }
function datetimeStrJST(d=nowJstObj()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"), ss=String(d.getSeconds()).padStart(2,"0");
  return `${y}-${m}-${da} ${hh}:${mi}:${ss}`;
}
function randomMinutes(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function csvEscape(v){ if(v==null) return ""; const s=String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }

/* =========== ãƒ¦ãƒ¼ã‚¶ãƒ¼/Dayä¿å­˜ï¼ˆDayç•ªå·ãƒ™ãƒ¼ã‚¹ï¼‰ =========== */
function loadUser(pid){ try{return JSON.parse(localStorage.getItem(`emotion_user_${pid}`))||null}catch{ return null } }
function saveUser(u){ try{localStorage.setItem(`emotion_user_${u.pid}`,JSON.stringify(u))}catch{} }
function ensureUser(pid){
  let u=loadUser(pid);
  if(!u){ u={pid, daysByNum:{}, weekly:{}, total_valid:0, max_day_num:1}; saveUser(u); }
  return u;
}
function ensureDay(u,dayNum){
  if(!u.daysByNum[dayNum]){ u.daysByNum[dayNum]={total_valid:0,sessions:[]}; if(dayNum>u.max_day_num) u.max_day_num=dayNum; saveUser(u); }
  return u.daysByNum[dayNum];
}
function setDayBadgeNum(n){ $("#dayBadge").textContent=String(n); $("#dayNum").value=String(n); }

/* =========== çŠ¶æ…‹å¤‰æ•° =========== */
let hr=null, rrList=[];
let timer=null, esmTimer=null, esmDueAt=0;
let sessionId=Math.random().toString(36).slice(2,10);
let spotifyAccessToken=null, spotifyRefreshToken=null, spotifyTokenExpAt=0;
let csvRows=[[]];
let validMin=0, playMin=0, anyBLE=false, bleDropped=false, lastHadBLE=false;
let currentEmotionKey=null, waitingSwitch=false;
let votes={tension:[],calm:[],depress:[]};
let lastEmotion="unknown", lastNonUnknown="unknown", lastNonUnknownAt=0;
let startedAtMs=0, paused=false, noPlayStreak=0;

/* =========== AutoSaveï¼ˆå½“æ—¥ã§ã¯ãªãâ€œé¸æŠDayâ€ã§å¾©å…ƒï¼‰ =========== */
const LS_KEY="emotion_recorder_autosave_v2";
function saveState(){
  try{
    const payload={
      csvRows, sessionId, validMin, playMin, anyBLE, bleDropped, lastHadBLE,
      currentEmotionKey, waitingSwitch, votes, lastEmotion, lastNonUnknown,
      lastNonUnknownAt, startedAtMs, paused, esmDueAt,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      pid:($("#pid").value||"pid"), condition:$("#cond").value, goal:$("#goalMin").value,
      dayNum: parseInt($("#dayNum").value||"1",10), algo: ALGO_VERSION
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }catch{}
}
function loadStateIfAny(){
  try{
    const s=localStorage.getItem(LS_KEY); if(!s) return false;
    const p=JSON.parse(s);
    csvRows=p.csvRows||[[]]; sessionId=p.sessionId||sessionId; validMin=p.validMin||0; playMin=p.playMin||0;
    anyBLE=!!p.anyBLE; bleDropped=!!p.bleDropped; lastHadBLE=!!p.lastHadBLE;
    currentEmotionKey=p.currentEmotionKey||null; waitingSwitch=!!p.waitingSwitch;
    votes=p.votes||{tension:[],calm:[],depress:[]};
    ["tension","calm","depress"].forEach(k=>{ if(votes[k].length>VOTE_WIN) votes[k]=votes[k].slice(-VOTE_WIN); });
    lastEmotion=p.lastEmotion||"unknown"; lastNonUnknown=p.lastNonUnknown||"unknown"; lastNonUnknownAt=p.lastNonUnknownAt||0;
    startedAtMs=p.startedAtMs||Date.now(); paused=!!p.paused; esmDueAt=p.esmDueAt||0;
    hr_base=p.hr_base??hr_base; rmssd_base=p.rmssd_base??rmssd_base; sd_hr=p.sd_hr??sd_hr; sd_rmssd=p.sd_rmssd??sd_rmssd;
    if(p.pid) $("#pid").value=p.pid; if(p.condition) $("#cond").value=p.condition; if(p.goal) $("#goalMin").value=p.goal;
    if(p.dayNum){ setDayBadgeNum(p.dayNum); }
    return true;
  }catch{ return false; }
}
function clearSavedState(){ localStorage.removeItem(LS_KEY); }

/* =========== HRV =========== */
function calcRMSSD(rrs){
  const xs=rrs.filter(x=>x>=0.3 && x<=2.0);
  if(xs.length<3) return null;
  let sum=0,n=0; for(let i=1;i<xs.length;i++){ const d=xs[i]-xs[i-1]; sum+=d*d; n++; }
  return Math.sqrt(sum/n);
}

/* =========== BLE =========== */
async function connectBLE(){
  try{
    log("ğŸ©º BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["heart_rate"]});
    const server=await dev.gatt.connect();
    const svc=await server.getPrimaryService("heart_rate");
    const ch=await svc.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged",(e)=>{
      const v=e.target.value, flags=v.getUint8(0), f16=(flags&0x01)!==0, hasRR=(flags&0x10)!==0;
      hr=f16?v.getUint16(1,true):v.getUint8(1);
      anyBLE=true; lastHadBLE=true;
      let idx=f16?3:2; const rrLocal=[];
      if(hasRR){ while(idx+1<v.byteLength){ rrLocal.push(v.getUint16(idx,true)/1024.0); idx+=2; } }
      if(rrLocal.length){ rrList.push(...rrLocal); if(rrList.length>60) rrList=rrList.slice(-60); }
      bleStateEl.textContent=`æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
    });
    dev.addEventListener("gattserverdisconnected",()=>{ bleStateEl.textContent="åˆ‡æ–­"; if(lastHadBLE) bleDropped=true; lastHadBLE=false; });
    bleStateEl.textContent="æ¥ç¶šå®Œäº†"; log("âœ… BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){ bleStateEl.textContent="æœªæ¥ç¶š"; log("âš ï¸ BLE error: "+err.message); }
}

/* =========== Spotifyï¼ˆPKCE/èµ·å‹•ï¼‰ =========== */
function base64url(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
async function pkce(){ const ver=base64url(crypto.getRandomValues(new Uint8Array(32))); const dig=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver)); const chal=base64url(dig); sessionStorage.setItem("pkce_verifier",ver); return chal; }
async function loginSpotify(){
  const code=new URLSearchParams(location.search).get("code");
  if(!code){
    const challenge=await pkce();
    location.href="https://accounts.spotify.com/authorize?"+new URLSearchParams({client_id:SPOTIFY_CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:"S256",code_challenge:challenge});
    return;
  }
  const ver=sessionStorage.getItem("pkce_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:SPOTIFY_CLIENT_ID,code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const t=await r.json();
  if(t.access_token){ spotifyAccessToken=t.access_token; spotifyRefreshToken=t.refresh_token||null; spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000);
    spStateEl.textContent="ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿"; log("âœ… Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"); history.replaceState({}, "", REDIRECT_URI);
  }else{ log("âš ï¸ Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(t)); }
}
async function refreshSpotifyIfNeeded(){
  if(!spotifyRefreshToken) return;
  if(Date.now()<spotifyTokenExpAt-30000) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:spotifyRefreshToken,client_id:SPOTIFY_CLIENT_ID});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const t=await r.json(); if(t.access_token){ spotifyAccessToken=t.access_token; spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000); log("ğŸ”„ Spotify: ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°"); }
}
async function spRequest(method,url,body){ await refreshSpotifyIfNeeded(); if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url,{method,headers:{"Authorization":"Bearer "+spotifyAccessToken,"Content-Type":"application/json"},body:body?JSON.stringify(body):undefined});
}
async function getDevices(){ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/devices"); const js=await r.json().catch(()=>({devices:[]}));
  const devs=js.devices||[]; log("ğŸ§ Devices: "+(devs.map(d=>`${d.name}${d.is_active?'(active)':''}`).join(", ")||"none")); return devs; }
async function ensureActiveDevice(){
  const devs=await getDevices(); if(devs.length===0){ log("âš ï¸ å†ç”Ÿç«¯æœ«ãªã—ï¼šSpotifyã‚¢ãƒ—ãƒªã§1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢â†’ã“ã®ç”»é¢ã¸"); return null; }
  const active=devs.find(d=>d.is_active)||devs[0];
  try{ await spRequest("PUT","https://api.spotify.com/v1/me/player",{device_ids:[active.id],play:false}); }catch(e){ log("transfer err: "+e.message); }
  return active.id;
}
async function ensureShuffleOn(){ try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }catch(e){} }
async function getCurrentPlaying(){ try{ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing"); if(r.status===204) return null; return await r.json(); }catch(_){ return null; } }
function extractTrackInfo(j){
  try{
    if(!j||!j.is_playing||!j.item) return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};
    const a=(j.item.artists||[]).map(x=>x.name).join(", "); const ctx=(j.context&&j.context.uri)?j.context.uri:"";
    return {track_id:j.item.id||"",track_name:j.item.name||"",artists:a,context_uri:ctx,duration_ms:j.item.duration_ms||0,progress_ms:j.progress_ms||0,is_playing:!!j.is_playing};
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false}; }
}
async function bootAndPlay(uri){
  const dev=await ensureActiveDevice(); if(!dev) return false;
  await ensureShuffleOn();
  let r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0});
  if(!r.ok){
    try{ await spRequest("POST","https://api.spotify.com/v1/me/player/next?device_id="+encodeURIComponent(dev)); }catch(_){}
    r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0});
    if(!r.ok){ log("âš ï¸ playå¤±æ•—: "+(await r.text()).slice(0,160)); return false; }
  }
  return true;
}
async function playPlaylist(uri){ const ok=await bootAndPlay(uri); if(!ok) log("âš ï¸ å†ç”Ÿã§ãã¾ã›ã‚“ï¼ˆç«¯æœ«/åºƒå‘Š/æ¨©é™ï¼‰"); }

/* =========== åˆ‡æ›¿ï¼ˆæ›²æœ«å¾…ã¡ï¼šæœ€å¤§5åˆ†ï¼‰ =========== */
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey || waitingSwitch) return;
  waitingSwitch=true;
  const uri = targetKey==="tension"?PLAYLIST_TENSION_TO_CALM:
              targetKey==="depress"?PLAYLIST_DEPRESS_TO_LIFT:PLAYLIST_CALM_MAINTAIN;
  const deadline=Date.now()+5*60*1000; let allow=false;
  while(Date.now()<deadline){
    const info=extractTrackInfo(await getCurrentPlaying());
    if(!info.is_playing||!info.duration_ms) break;
    const remain=Math.max(0, info.duration_ms-(info.progress_ms||0));
    if(remain<=3500){ allow=true; break; }
    await new Promise(r=>setTimeout(r,1200));
  }
  if(allow){ await playPlaylist(uri); currentEmotionKey=targetKey; log(`ğŸµ Playlist â†’ ${targetKey}`); }
  else{ log("ğŸµ Switch skipped (no end-of-track within 5min)"); }
  waitingSwitch=false;
}

/* =========== åˆ¤å®šï¼ˆZï¼‹å¤šæ•°æ±ºï¼‹3åˆ†ç¶­æŒï¼‰ =========== */
function pushVote(key, ok){ const a=votes[key]; a.push(ok?1:0); if(a.length>VOTE_WIN) a.shift(); return a.reduce((x,y)=>x+y,0)>=VOTE_NEED; }
function decideEmotion(hrValue, rmssd, z_hr, z_rmssd){
  if(rmssd==null || z_hr==="" || z_rmssd==="") return "unknown";
  if(Date.now()-startedAtMs >= WARMUP_MIN*60*1000){
    if(lastNonUnknown!=="unknown" && (Date.now()-lastNonUnknownAt)<SEG_MIN_MIN*60*1000) return lastNonUnknown;
  }
  const candT = (z_rmssd<=ZTH.T_RMSSD_STRONG) || (z_rmssd<=ZTH.T_RMSSD_SOFT && z_hr>=ZTH.T_HR_HELP);
  const candC = (z_rmssd>=ZTH.C_RMSSD_STRONG) || (z_rmssd>=ZTH.C_RMSSD_SOFT && z_hr<=ZTH.C_HR_HELP);
  const candD = (z_hr<=ZTH.D_HR_LOW && z_rmssd>=ZTH.D_RMSSD_LOW && z_rmssd<=ZTH.D_RMSSD_HIGH);
  const okC=pushVote("calm",candC), okT=pushVote("tension",candT), okD=pushVote("depress",candD);
  let decided="unknown"; if(okC) decided="calm"; else if(okT) decided="tension"; else if(okD) decided="depress";
  if(decided!=="unknown" && (Date.now()-startedAtMs)>=WARMUP_MIN*60*1000){ lastNonUnknown=decided; lastNonUnknownAt=Date.now(); }
  lastEmotion=decided; return decided;
}

/* =========== ESMï¼ˆ30åˆ†Â±ã‚†ã‚‰ãï¼‰ =========== */
function scheduleNextESM(){
  clearTimeout(esmTimer);
  const m=randomMinutes(28,34);
  esmDueAt=Date.now()+m*60*1000;
  const d=new Date(esmDueAt);
  const j=nowJstObj(); j.setTime(esmDueAt);
  const hh=String(j.getHours()).padStart(2,"0")+":"+String(j.getMinutes()).padStart(2,"0");
  esmNext.textContent=`ESM: ${hh}é ƒ`;
  esmTimer=setTimeout(()=>{ $("#esmModal").style.display="flex"; }, m*60*1000);
}
$("#esmModal").addEventListener("click",(e)=>{ if(e.target===$("#esmModal")) $("#esmModal").style.display="none"; });
document.querySelectorAll("#esmModal button[data-esm]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const val=btn.getAttribute("data-esm");
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), // æ—§è¡¨ç¤ºæ—¥ä»˜/JSTæ—¥ä»˜
      parseInt($("#dayNum").value||"1",10),                // è¿½åŠ ï¼šday_numï¼ˆæ‰‹å‹•ï¼‰
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "esm",val,
      "","", ALGO_VERSION
    ]);
    log(`ğŸ—³ï¸ ESM: ${val}`); $("#esmModal").style.display="none"; scheduleNextESM(); saveState();
  });
});

/* =========== ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆEWMAï¼‰ =========== */
let prevHR=null, prevRMSSD=null;
let hr_base=70, sd_hr=8, rmssd_base=0.04, sd_rmssd=0.018;
const EWMA=0.05;

/* =========== CSVãƒ˜ãƒƒãƒ€ï¼ˆJSTåˆ—ï¼‰ =========== */
function makeHeader(){
  csvRows=[[ "timestamp","datetime_jst","pid","day_local","day_iso_jst","day_num",
    "session_id","block","condition",
    "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
    "roll_std_h","roll_std_rr","emotion",
    "track_id","track_name","artists","context_uri",
    "hr_base","rmssd_base","sd_hr","sd_rmssd",
    "is_playing","exercise","valid_for_rank",
    "valid_for_rank_none","valid_for_rank_music","valid_for_rank_both",
    "mood","relax","note","event","esm",
    "session_minutes_valid","reason_invalid","algo_version"
  ]];
}

/* =========== 1åˆ†åˆ»ã¿å‡¦ç† =========== */
async function oneTick(){
  const pid=($("#pid").value||"").trim()||"pid";
  const condition=$("#cond").value;
  const goal=parseInt($("#goalMin").value||"120",10);
  const dayNum=parseInt($("#dayNum").value||"1",10);

  const rmssd=calcRMSSD(rrList.slice(-10));
  const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
  const z_hr     = (hr!=null) ? (hr-hr_base)/sd_hr : "";
  const z_rmssd  = (rmssd!=null) ? (rmssd-rmssd_base)/sd_rmssd : "";
  const d_hr     = (prevHR!=null && hr!=null) ? (hr-prevHR) : "";
  const d_rmssd  = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD) : "";
  const emotion  = decideEmotion(hr, rmssd, z_hr, z_rmssd);

  let playing=false, info={track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false};
  try{ info=extractTrackInfo(await getCurrentPlaying()); playing=!!info.is_playing; }catch{}

  const exercise = (hr!=null && hr_base!=null && hr >= hr_base+25) ? 1 : 0;

  const valid_for_rank = (condition==="NONE" && playing && !exercise) ? 1 : 0;
  const valid_for_rank_none  = (condition==="NONE"  && !exercise) ? 1 : 0;
  const valid_for_rank_music = (condition==="MUSIC" && playing && !exercise) ? 1 : 0;
  const valid_for_rank_both  = (condition==="BOTH"  && playing && !exercise) ? 1 : 0;

  const gotHR=(hr!=null);
  if(gotHR){
    if(condition==="MUSIC"||condition==="BOTH"){ if(playing){ validMin++; playMin++; } }
    else{ validMin++; }
  }

  // keep-alive
  if((condition==="MUSIC"||condition==="BOTH") && !exercise){
    if(playing) noPlayStreak=0;
    else { noPlayStreak++; if(noPlayStreak>=2){ log("ğŸ§ keep-alive: å†ç”Ÿèµ·å‹•ã‚’è©¦è¡Œ"); await playPlaylist(PLAYLIST_CALM_MAINTAIN); noPlayStreak=0; } }
  }

  updateGoalView(goal);

  if((condition==="MUSIC"||condition==="BOTH") && !exercise){
    const key = emotion==="tension"?"tension":(emotion==="calm"?"calm":(emotion==="depress"?"depress":null));
    if(key) scheduleSwitchIfNeeded(key);
  }

  csvRows.push([
    Date.now(), datetimeStrJST(), pid,
    new Date().toLocaleDateString("ja-JP"), dayIsoJST(), dayNum,
    sessionId,"block1", condition,
    hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
    "", "", emotion,
    info.track_id, info.track_name, info.artists, info.context_uri,
    hr_base, rmssd_base, sd_hr, sd_rmssd,
    playing?1:0, exercise, valid_for_rank,
    valid_for_rank_none, valid_for_rank_music, valid_for_rank_both,
    "", "", "", "", "",
    "", "", ALGO_VERSION
  ]);

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆã»ã¼ä¸­ç«‹ï¼‰
  if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
    hr_base=(1-EWMA)*hr_base + EWMA*hr;
    rmssd_base=(1-EWMA)*rmssd_base + EWMA*rmssd;
    sd_hr=Math.max(SD_HR_FLOOR, (1-EWMA)*sd_hr + EWMA*Math.abs(hr-hr_base));
    sd_rmssd=Math.max(SD_RMSSD_FLOOR, (1-EWMA)*sd_rmssd + EWMA*Math.abs(rmssd-rmssd_base));
  }

  prevHR=hr; prevRMSSD=rmssd;

  // é¸æŠDayã¸ç©ç®—ä¿å­˜
  try{ const u=ensureUser(pid); const d=ensureDay(u, dayNum); d.total_valid=validMin; saveUser(u); setDayBadgeNum(dayNum);}catch{}

  log(`[tick JST] HR=${hr??"-"} playing=${playing?1:0} ex=${exercise} emotion=${emotion} validMin=${validMin}`);
  // è‡ªå‹•çµ‚äº†ï¼šç›®æ¨™åˆ°é”ã®ã¿
  if($("#autoStop").checked && validMin>=goal){ log("â± ç›®æ¨™åˆ°é”â†’è‡ªå‹•çµ‚äº†"); stopSession(); return; }

  saveState();
}
function startTicking(){ if(timer) clearInterval(timer); timer=setInterval(oneTick, 60*1000); }

/* =========== UI/ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† =========== */
function updateGoalView(goal){
  const weekly=$("#weeklyMode").checked;
  if(!weekly){
    const g=goal?goal:parseInt($("#goalMin").value||"120",10);
    $("#goalText").textContent=`é€²æ—: ${validMin} / ${g}åˆ†`;
    const p=Math.max(0,Math.min(100, (validMin/g)*100 ));
    $("#goalBar").style.width=p+"%";
    $("#goalBar").style.background= (validMin>=g) ? "linear-gradient(90deg,#16a34a,#22c55e)" : "linear-gradient(90deg,#3870ff,#50e3c2)";
  }else{
    const pid=($("#pid").value||"pid").trim(); const u=ensureUser(pid);
    const weekKey = new Date().toISOString().slice(0,10); // è¡¨ç¤ºã®ã¿ç°¡æ˜“
    const got=(u.weekly[weekKey]||0);
    $("#weeklyProg").textContent=`${got} åˆ†`;
    $("#goalText").textContent=`ä»Šã‚»ãƒƒã‚·ãƒ§ãƒ³: ${validMin} åˆ†`;
    $("#goalBar").style.width="0%";
  }
}
$("#weeklyMode").addEventListener("change",(e)=>{ $("#weeklyBox").style.display=e.target.checked?"flex":"none"; updateGoalView(); });

function makeButtonsState(running){
  $("#btnStart").disabled=running; $("#btnStop").disabled=!running;
  $("#btnPause").disabled=!running; $("#btnResume").disabled=true;
  $("#btnCsv").disabled=running;
}
function makeHeaderAndReset(){
  makeHeader();
  sessionId=Math.random().toString(36).slice(2,10);
  validMin=0; playMin=0; anyBLE=false; bleDropped=false; lastHadBLE=false;
  currentEmotionKey=null; waitingSwitch=false; noPlayStreak=0;
  votes={tension:[],calm:[],depress:[]}; lastEmotion="unknown"; lastNonUnknown="unknown"; lastNonUnknownAt=0;
  startedAtMs=Date.now();
}
function startSession(){
  const pid=($("#pid").value||"pid").trim();
  const dayNum=parseInt($("#dayNum").value||"1",10);
  const u=ensureUser(pid); ensureDay(u, dayNum); setDayBadgeNum(dayNum);

  makeButtonsState(true); makeHeaderAndReset(); updateGoalView(); log("â–¶ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
  scheduleNextESM();

  if($("#cond").value==="MUSIC"||$("#cond").value==="BOTH"){ playPlaylist(PLAYLIST_CALM_MAINTAIN); }
  startTicking(); saveState();
}
function stopSession(){
  clearInterval(timer); timer=null; clearTimeout(esmTimer); esmTimer=null; esmNext.textContent="ESM: æœªäºˆå®š";
  makeButtonsState(false);

  const condition=$("#cond").value, dayNum=parseInt($("#dayNum").value||"1",10);
  let reasons=[]; if(validMin<60) reasons.push("<60min");
  if((condition==="MUSIC"||condition==="BOTH") && playMin<30) reasons.push("playing<30");
  if(bleDropped) reasons.push("ble_drop");
  const reason_invalid=reasons.join("+")||"";

  if(csvRows.length>1){
    const last=csvRows[csvRows.length-1];
    last[last.length-3]=String(validMin);
    last[last.length-2]=reason_invalid;
  }else{
    csvRows.push([Date.now(), datetimeStrJST(), ($("#pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), dayIsoJST(), dayNum,
      sessionId,"block1", $("#cond").value,
      "","","","","","","","","","", "","","","",
      hr_base,rmssd_base,sd_hr,sd_rmssd, 0,0, 0,0,0,0, "","","", "end","",
      String(validMin), reason_invalid, ALGO_VERSION
    ]);
  }

  try{
    const pid=($("#pid").value||"pid").trim(); const u=ensureUser(pid); const d=ensureDay(u, dayNum);
    d.total_valid += validMin;
    d.sessions.push({session_id:sessionId,condition,day_num:dayNum,minutes:validMin,play_minutes:playMin,reason_invalid,
                     started_at_jst:datetimeStrJST(new Date(startedAtMs)), ended_at_jst:datetimeStrJST()});
    u.total_valid += validMin; saveUser(u); setDayBadgeNum(dayNum);
  }catch{}

  clearSavedState();
  log(`â–  ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†, ç†ç”±=${reason_invalid||"ãªã—"}ï¼‰`);
}

/* =========== ã‚¢ãƒ³ã‚±/CSV =========== */
$("#btnNote").onclick=()=>{ const mood=$("#mood").value||"", relax=$("#relax").value||"", notes=$("#notes").value||"";
  if(csvRows.length>1){ const im=csvRows[0].indexOf("mood"), ir=csvRows[0].indexOf("relax"), inx=csvRows[0].indexOf("note");
    const last=csvRows[csvRows.length-1]; last[im]=mood; last[ir]=relax; last[inx]=notes; }
  log("ğŸ“ ã‚¢ãƒ³ã‚±è¿½åŠ "); saveState(); };
$("#btnCsv").onclick=()=>{ const lines=csvRows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const blob=new Blob([lines],{type:"text/csv"});
  const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:`emotion_log_${dayIsoJST()}_${sessionId}.csv`});
  a.click(); URL.revokeObjectURL(a.href); };

/* =========== ã‚¤ãƒ™ãƒ³ãƒˆ/å¾©å…ƒ =========== */
$("#btnBle").onclick=connectBLE;
$("#btnSp").onclick=loginSpotify;
$("#btnStart").onclick=startSession;
$("#btnStop").onclick=stopSession;
$("#btnClear").onclick=clearLog;

$("#pid").addEventListener("change",()=>{ const pid=($("#pid").value||"pid").trim(); const u=ensureUser(pid); ensureDay(u, parseInt($("#dayNum").value||"1",10)); });

$("#dayMinus").onclick=()=>{ const n=Math.max(1, parseInt($("#dayNum").value||"1",10)-1); setDayBadgeNum(n); saveState(); };
$("#dayPlus").onclick =()=>{ const n=parseInt($("#dayNum").value||"1",10)+1; setDayBadgeNum(n); saveState(); };

$("#btnPlayCalm").onclick=()=>playPlaylist(PLAYLIST_CALM_MAINTAIN);
$("#btnPlayTen").onclick =()=>playPlaylist(PLAYLIST_TENSION_TO_CALM);
$("#btnPlayDep").onclick =()=>playPlaylist(PLAYLIST_DEPRESS_TO_LIFT);

if(new URLSearchParams(location.search).get("code")) loginSpotify();
if(loadStateIfAny()){
  const pid=($("#pid").value||"pid").trim(); ensureUser(pid); setDayBadgeNum(parseInt($("#dayNum").value||"1",10));
  updateGoalView(); log("ğŸ§© é€”ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  if(paused){ $("#btnStart").disabled=true; $("#btnStop").disabled=true; $("#btnPause").disabled=true; $("#btnResume").disabled=false; }
  else{ makeButtonsState(true); if(esmDueAt>0){ const j=nowJstObj(); j.setTime(esmDueAt); const hh=String(j.getHours()).padStart(2,"0")+":"+String(j.getMinutes()).padStart(2,"0"); esmNext.textContent=`ESM: ${hh}é ƒ`; }
        scheduleNextESM(); startTicking(); }
}
window.addEventListener("beforeunload",(e)=>{
  const running=!$("#btnStop").disabled, hasRows=(csvRows && csvRows.length>1);
  if(running || hasRows){ e.preventDefault(); e.returnValue=""; }
});
</script>
</body>
</html>
