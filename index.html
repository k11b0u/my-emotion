<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root { color-scheme: light dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:920px;margin:20px auto;padding:0 12px}
  .card{border:1px solid #333;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 1px 4px rgba(0,0,0,.12);background:#121212}
  button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1e1e1e;color:#f1f1f1;cursor:pointer}
  button:hover:not(:disabled){ background:#2a2a2a }
  button:disabled{ background:#2a2a2a; color:#9aa; border-color:#444; opacity:1; cursor:not-allowed }
  code{background:#1a1a1a;padding:2px 6px;border-radius:6px}
  .ok{color:#27c052;font-weight:700}.bad{color:#ff5252;font-weight:700}.muted{color:#b0b0b0}
  input,textarea,select{width:100%;padding:8px;border:1px solid #444;border-radius:10px;background:#1a1a1a;color:#eee}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > * { flex:1 }
  .logbox{white-space:pre-wrap;height:200px;overflow:auto;background:#0f0f0f;color:#e8e8e8;border:1px solid #333;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #444;border-radius:999px;padding:6px 10px;background:#1a1a1a}
  .goalok{color:#27c052}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:#171717;border:1px solid #333;border-radius:14px;padding:18px;max-width:460px;width:92%}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btns button{flex:1}
</style>
</head>
<body>
<h1>Emotion Record</h1>

<div class="card">
  <h2>çŠ¶æ…‹</h2>
  <p>
    BLE: <span id="bleState">æœªæ¥ç¶š</span> ï¼
    Spotify: <span id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
  </p>
  <div class="row">
    <button id="btnBle">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šï¼ˆCOOSPOï¼‰</button>
    <button id="btnSp">Spotifyãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btnStart">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
    <button id="btnStop" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</button>
    <button id="btnPause" disabled>ä¸€æ™‚åœæ­¢</button>
    <button id="btnResume" disabled>å†é–‹</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æç”¨ãƒ©ãƒ™ãƒ«ï¼‰</label>
      <select id="cond">
        <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
        <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
        <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
        <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
      </select>
      <small class="muted">â€» è§£æç”¨ãƒ©ãƒ™ãƒ«ã€‚å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰å´ã§åˆ¶å¾¡ã€‚</small>
    </div>
    <div>
      <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
      <input id="pid" placeholder="hiro" value="hiro"/>
    </div>
    <div>
      <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
      <select id="goalMin">
        <option value="90">90åˆ†</option>
        <option value="120" selected>120åˆ†</option>
        <option value="150">150åˆ†</option>
      </select>
      <div id="goalView" class="muted pill" style="margin-top:6px">é€²æ—: 0 / 120åˆ†</div>
    </div>
    <div>
      <label>å®Ÿé¨“æ—¥ï¼ˆDayï¼‰</label>
      <div id="dayBadge" class="pill muted">Day ?</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <label class="pill"><input type="checkbox" id="autoStop" checked> ç›®æ¨™åˆ°é”/23:00ã§è‡ªå‹•çµ‚äº†</label>
    <label class="pill"><input type="checkbox" id="weeklyMode"> é€±åˆè¨ˆã§ç®¡ç†ã™ã‚‹ï¼ˆä¾‹: 480åˆ†/é€±ï¼‰</label>
  </div>

  <div class="row" id="weeklyBox" style="display:none;margin-top:6px">
    <div>
      <label>ä»Šé€±ã®ç›®æ¨™åˆè¨ˆï¼ˆåˆ†ï¼‰</label>
      <input type="number" id="weeklyGoal" value="480" min="60" step="30">
    </div>
    <div class="muted" id="weeklyProg" style="align-self:flex-end">ä»Šé€±ã®å–å¾—: 0 åˆ†</div>
  </div>
</div>

<div class="card">
  <h2>ãƒ­ã‚°</h2>
  <pre id="log" class="logbox" aria-live="polite"></pre>
  <div class="row">
    <button id="btnCsv" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnClear">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<div class="card">
  <h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div class="row">
    <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
    <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
  </div>
  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
  <button id="btnNote">è¿½åŠ </button>
</div>

<!-- ESM ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ">
  <div class="box">
    <h3 style="margin:0 0 8px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="btns">
      <button data-esm="tense">ç·Šå¼µï¼ˆé«˜ã¶ã‚Š/ç„¦ã‚Šï¼‰</button>
      <button data-esm="calm">é®é™ï¼ˆè½ã¡ç€ãï¼‰</button>
      <button data-esm="depress">è½ã¡è¾¼ã¿ï¼ˆæ°—åˆ†â†“ï¼‰</button>
      <button data-esm="skip">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
// ===== è¨­å®š =====
const SPOTIFY_CLIENT_ID = "7838a0cf003644ae8b5f3f75b9eb534e";
const REDIRECT_URI       = location.origin + location.pathname;
const SCOPES = [
  "user-read-playback-state","user-modify-playback-state",
  "playlist-read-private","playlist-read-collaborative","streaming"
].join(" ");
const PLAYLIST_TENSION_TO_CALM = "spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT = "spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN   = "spotify:playlist:2m9HoHfpO0tk5eky1fopVu";
const ALGO_VERSION = "v1.3";

// ===== ã—ãã„å€¤ï¼ˆç ”ç©¶å›ºå®šï¼‰ =====
const ZTH = {
  T_RMSSD_STRONG: -0.60, T_RMSSD_SOFT: -0.30, T_HR_HELP: 0.20,
  C_RMSSD_STRONG:  0.60, C_RMSSD_SOFT:  0.30, C_HR_HELP:  0.20,
  D_HR_LOW:       -0.40, D_RMSSD_LOW:  -0.20, D_RMSSD_HIGH: 0.10
};
const VOTE_WIN=5, VOTE_NEED=3, SEG_MIN_MIN=3, WARMUP_MIN=3;
const SD_HR_FLOOR=3.0, SD_RMSSD_FLOOR=0.015;   // 15ms
const CUTOFF_HOUR=23;

// ===== ä¾¿åˆ© =====
const logEl=document.getElementById("log");
const bleStateEl=document.getElementById("bleState");
const spStateEl=document.getElementById("spState");
const btnCsv=document.getElementById("btnCsv");
const btnClear=document.getElementById("btnClear");
const condSel=document.getElementById("cond");
const goalSel=document.getElementById("goalMin");
const goalView=document.getElementById("goalView");
const esmModal=document.getElementById("esmModal");
const dayBadge=document.getElementById("dayBadge");

function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent=""; }
function isoNow(){ return new Date().toISOString().replace("T"," ").slice(0,19); }
function isoDay(){ return new Date().toISOString().slice(0,10); }
function csvEscape(v){ if(v==null) return ""; const s=String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
function randomMinutes(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function isPastCutoff(){ return (new Date()).getHours() >= CUTOFF_HOUR; }

// ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼/Dayä¿å­˜ =====
function dayISO(d=new Date()){ return d.toISOString().slice(0,10); }
function toWeekKey(d=new Date()){
  const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum=tmp.getUTCDay()||7; tmp.setUTCDate(tmp.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const w=Math.ceil((((tmp-yearStart)/86400000)+1)/7);
  return `${tmp.getUTCFullYear()}-W${String(w).padStart(2,'0')}`;
}
function loadUser(pid){ try{ return JSON.parse(localStorage.getItem(`emotion_user_${pid}`))||null; }catch{ return null; } }
function saveUser(u){ try{ localStorage.setItem(`emotion_user_${u.pid}`, JSON.stringify(u)); }catch{} }
function ensureUser(pid){
  let u=loadUser(pid);
  if(!u){ u={pid, study_start_iso: dayISO(), days:{}, weekly:{}, total_valid:0, total_days:0}; saveUser(u); }
  return u;
}
function ensureUserDay(u, iso){
  if(!u.days[iso]){ u.total_days+=1; u.days[iso]={day_num:u.total_days,total_valid:0,sessions:[]}; saveUser(u); }
  return u.days[iso];
}
function bumpWeekly(u, minutes, d=new Date()){ const wk=toWeekKey(d); u.weekly[wk]=(u.weekly[wk]||0)+minutes; saveUser(u); }
function setDayBadge(u, iso){ const info=u.days[iso]; dayBadge.textContent = `Day ${info?info.day_num:"?"}`; }

// ====== çŠ¶æ…‹å¤‰æ•° ======
let hr=null, rrList=[];
let timer=null, esmTimer=null;
let sessionId=Math.random().toString(36).slice(2,10);
let spotifyAccessToken=null, spotifyRefreshToken=null, spotifyTokenExpAt=0;
let csvRows=[[]];
let validMin=0, playMin=0, anyBLE=false, bleDropped=false, lastHadBLE=false;
let currentEmotionKey=null, waitingSwitch=false;
let votes={tension:[],calm:[],depress:[]};
let lastEmotion="unknown", lastNonUnknown="unknown", lastNonUnknownAt=0;
let startedAtMs=0, paused=false, noPlayStreak=0;

// ====== AutoSave ======
const LS_KEY="emotion_recorder_autosave_v1";
function saveState(){
  try{
    const payload={
      csvRows, sessionId, validMin, playMin, anyBLE, bleDropped, lastHadBLE,
      currentEmotionKey, waitingSwitch, votes, lastEmotion, lastNonUnknown,
      lastNonUnknownAt, startedAtMs, paused,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      pid:(document.getElementById("pid").value||"pid"), condition:condSel.value, goal:goalSel.value,
      dayISO: isoDay(), algo: ALGO_VERSION
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }catch{}
}
function loadStateIfAny(){
  try{
    const s=localStorage.getItem(LS_KEY); if(!s) return false;
    const p=JSON.parse(s);
    if(p.dayISO!==isoDay()) { localStorage.removeItem(LS_KEY); return false; }

    csvRows=p.csvRows||[[]]; sessionId=p.sessionId||sessionId;
    validMin=p.validMin||0; playMin=p.playMin||0; anyBLE=!!p.anyBLE;
    bleDropped=!!p.bleDropped; lastHadBLE=!!p.lastHadBLE;
    currentEmotionKey=p.currentEmotionKey||null; waitingSwitch=!!p.waitingSwitch;
    votes=p.votes||{tension:[],calm:[],depress:[]};
    // votesãŒè‚¥å¤§åŒ–ã—ã¦ã„ãŸã‚‰çª“å¹…ã«ä¸¸ã‚ã‚‹ï¼ˆå¾©å…ƒæ™‚ãƒã‚°æ½°ã—ï¼‰
    ["tension","calm","depress"].forEach(k=>{ if(votes[k].length>VOTE_WIN) votes[k]=votes[k].slice(-VOTE_WIN); });

    lastEmotion=p.lastEmotion||"unknown"; lastNonUnknown=p.lastNonUnknown||"unknown";
    lastNonUnknownAt=p.lastNonUnknownAt||0; startedAtMs=p.startedAtMs||Date.now();
    paused=!!p.paused;

    hr_base=p.hr_base??hr_base; rmssd_base=p.rmssd_base??rmssd_base;
    sd_hr=p.sd_hr??sd_hr; sd_rmssd=p.sd_rmssd??sd_rmssd;

    if(p.pid) document.getElementById("pid").value=p.pid;
    if(p.condition) condSel.value=p.condition;
    if(p.goal) goalSel.value=p.goal;
    return true;
  }catch{ return false; }
}
function clearSavedState(){ localStorage.removeItem(LS_KEY); }

// ===== HRVï¼ˆRRã¯ç§’ã€0.3ã€œ2.0sã®ã¿æ¡ç”¨ï¼‰=====
function calcRMSSD(rrs){
  const xs=rrs.filter(x=>x>=0.3 && x<=2.0);
  if(xs.length<3) return null;
  let sum=0,n=0; for(let i=1;i<xs.length;i++){ const d=xs[i]-xs[i-1]; sum+=d*d; n++; }
  return Math.sqrt(sum/n);
}

// ===== Web Bluetoothï¼ˆç°¡æ˜“ï¼‰=====
async function connectBLE(){
  try{
    log("BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}], optionalServices:["heart_rate"]});
    const server=await dev.gatt.connect();
    const service=await server.getPrimaryService("heart_rate");
    const ch=await service.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged",(e)=>{
      const v=e.target.value, flags=v.getUint8(0), f16=(flags&0x01)!==0, hasRR=(flags&0x10)!==0;
      hr = f16? v.getUint16(1,true) : v.getUint8(1);
      anyBLE=true; lastHadBLE=true;
      let idx=f16?3:2; const rrLocal=[];
      if(hasRR){ while(idx+1<v.byteLength){ rrLocal.push(v.getUint16(idx,true)/1024.0); idx+=2; } }
      if(rrLocal.length){ rrList.push(...rrLocal); if(rrList.length>60) rrList=rrList.slice(-60); }
      bleStateEl.textContent=`æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
    });
    dev.addEventListener("gattserverdisconnected",()=>{ bleStateEl.textContent="åˆ‡æ–­"; if(lastHadBLE) bleDropped=true; lastHadBLE=false; });
    bleStateEl.textContent="æ¥ç¶šå®Œäº†"; log("BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){ log("BLE error: "+err.message); bleStateEl.textContent="æœªæ¥ç¶š"; }
}

// ===== Spotifyï¼ˆPKCE + keep-aliveï¼‰=====
function base64url(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
async function pkce(){ const ver=base64url(crypto.getRandomValues(new Uint8Array(32))); const dig=await crypto.subtle.digest("SHA-256", new TextEncoder().encode(ver)); const chal=base64url(dig); sessionStorage.setItem("pkce_verifier", ver); return chal; }
async function loginSpotify(){
  const code=new URLSearchParams(location.search).get("code");
  if(!code){
    const challenge=await pkce();
    location.href="https://accounts.spotify.com/authorize?"+new URLSearchParams({
      client_id:SPOTIFY_CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:"S256",code_challenge:challenge
    });
    return;
  }
  const ver=sessionStorage.getItem("pkce_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:SPOTIFY_CLIENT_ID,code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const tok=await r.json();
  if(tok.access_token){
    spotifyAccessToken=tok.access_token; spotifyRefreshToken=tok.refresh_token||null; spotifyTokenExpAt=Date.now()+((tok.expires_in||3600)*1000);
    spStateEl.textContent="ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿"; log("Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"); history.replaceState({}, "", REDIRECT_URI);
  }else{ log("Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(tok)); }
}
async function refreshSpotifyIfNeeded(){
  if(!spotifyRefreshToken) return;
  if(Date.now()<spotifyTokenExpAt-30000) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:spotifyRefreshToken,client_id:SPOTIFY_CLIENT_ID});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const tok=await r.json();
  if(tok.access_token){ spotifyAccessToken=tok.access_token; spotifyTokenExpAt=Date.now()+((tok.expires_in||3600)*1000); log("Spotify: ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°"); }
}
async function spRequest(method,url,body){ await refreshSpotifyIfNeeded(); if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url,{method,headers:{"Authorization":"Bearer "+spotifyAccessToken,"Content-Type":"application/json"},body:body?JSON.stringify(body):undefined});
}
async function getDevices(){
  const r=await spRequest("GET","https://api.spotify.com/v1/me/player/devices");
  const js=await r.json().catch(()=>({devices:[]}));
  const devs=js.devices||[];
  log("Spotify devices: "+(devs.map(d=>`${d.name}${d.is_active?'(active)':''}`).join(", ")||"none"));
  return devs;
}
async function ensureActiveDevice(){
  const devs=await getDevices();
  if(devs.length===0){ log("Spotify: ç«¯æœ«ãªã—ï¼ˆã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢ã—ã¦ãã ã•ã„ï¼‰"); return null; }
  const active=devs.find(d=>d.is_active)||devs[0];
  try{ await spRequest("PUT","https://api.spotify.com/v1/me/player",{device_ids:[active.id],play:false}); }catch(e){ log("transfer err: "+e.message); }
  log("use device: "+active.name);
  return active.id;
}
async function ensureShuffleOn(){ try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }catch(e){ log("shuffle err: "+e.message);} }
async function getCurrentPlaying(){ try{ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing"); if(r.status===204) return null; return await r.json(); }catch(_){ return null; } }
function extractTrackInfo(j){
  try{
    if(!j||!j.is_playing||!j.item) return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};
    const item=j.item, artists=(item.artists||[]).map(a=>a.name).join(", "), ctx=(j.context&&j.context.uri)?j.context.uri:"";
    return {track_id:item.id||"",track_name:item.name||"",artists,context_uri:ctx,duration_ms:item.duration_ms||0,progress_ms:j.progress_ms||0,is_playing:!!j.is_playing};
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false}; }
}
async function bootAndPlay(uri){
  const devId=await ensureActiveDevice(); if(!devId) return false;
  let r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(devId),{context_uri:uri,position_ms:0});
  if(!r.ok){
    const t=await r.text(); log("play err(1): "+t.slice(0,200));
    try{ await spRequest("POST","https://api.spotify.com/v1/me/player/next?device_id="+encodeURIComponent(devId)); }catch(_){}
    r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(devId),{context_uri:uri,position_ms:0});
    if(!r.ok){ log("play err(2): "+(await r.text()).slice(0,200)); return false; }
  }
  return true;
}
async function playPlaylist(uri){
  await ensureShuffleOn();
  const ok=await bootAndPlay(uri);
  if(!ok) log("play failed: device/åºƒå‘Š/åˆ¶é™ã®å¯èƒ½æ€§");
}

// ===== åˆ‡æ›¿ï¼šæ›²æœ«å¾…ã¡â†’æ¥ãªã‘ã‚Œã°5åˆ†ã§è«¦ã‚ï¼ˆé€”ä¸­åˆ‡æ›¿ã›ãšï¼‰=====
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey || waitingSwitch) return;
  waitingSwitch=true;
  const uri=targetKey==="tension"?PLAYLIST_TENSION_TO_CALM: targetKey==="depress"?PLAYLIST_DEPRESS_TO_LIFT: PLAYLIST_CALM_MAINTAIN;
  const deadline=Date.now()+5*60*1000; let allow=false;
  while(Date.now()<deadline){
    const info=extractTrackInfo(await getCurrentPlaying());
    if(!info.is_playing||!info.duration_ms) break;
    const remain=Math.max(0, info.duration_ms-(info.progress_ms||0));
    if(remain<=3500){ allow=true; break; }
    await new Promise(r=>setTimeout(r,1500));
  }
  if(allow){ await playPlaylist(uri); currentEmotionKey=targetKey; log(`ğŸµ Playlist â†’ ${targetKey}`); }
  else{ log("ğŸµ Switch skipped (no end-of-track within 5min)"); }
  waitingSwitch=false;
}

// ===== åˆ¤å®š =====
function pushVote(key, ok){ const arr=votes[key]; arr.push(ok?1:0); if(arr.length>VOTE_WIN) arr.shift(); return arr.reduce((a,b)=>a+b,0)>=VOTE_NEED; }
function decideEmotion(hrValue, rmssd, z_hr, z_rmssd){
  if(rmssd==null || z_hr==="" || z_rmssd==="") return "unknown";
  if(Date.now()-startedAtMs >= WARMUP_MIN*60*1000){
    if(lastNonUnknown!=="unknown" && (Date.now()-lastNonUnknownAt)<SEG_MIN_MIN*60*1000) return lastNonUnknown;
  }
  const candT = (z_rmssd<=ZTH.T_RMSSD_STRONG) || (z_rmssd<=ZTH.T_RMSSD_SOFT && z_hr>=ZTH.T_HR_HELP);
  const candC = (z_rmssd>=ZTH.C_RMSSD_STRONG) || (z_rmssd>=ZTH.C_RMSSD_SOFT && z_hr<=ZTH.C_HR_HELP);
  const candD = (z_hr<=ZTH.D_HR_LOW && z_rmssd>=ZTH.D_RMSSD_LOW && z_rmssd<=ZTH.D_RMSSD_HIGH);
  const okC=pushVote("calm",candC), okT=pushVote("tension",candT), okD=pushVote("depress",candD);
  let decided="unknown"; if(okC) decided="calm"; else if(okT) decided="tension"; else if(okD) decided="depress";
  if(decided!=="unknown" && (Date.now()-startedAtMs)>=WARMUP_MIN*60*1000){ lastNonUnknown=decided; lastNonUnknownAt=Date.now(); }
  lastEmotion=decided; return decided;
}

// ===== ESM =====
function scheduleNextESM(){ clearTimeout(esmTimer); const m=randomMinutes(28,34); esmTimer=setTimeout(()=>{ esmModal.style.display="flex"; }, m*60*1000); }
esmModal.addEventListener("click",(e)=>{ if(e.target===esmModal) esmModal.style.display="none"; });
esmModal.querySelectorAll("button[data-esm]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const val=btn.getAttribute("data-esm");
    csvRows.push([ Date.now(), isoNow(), (document.getElementById("pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), isoDay(), sessionId, "block1", condSel.value,
      "","","","","","","","","","",
      "","","","", "","","","", 0,0,
      0,0,0,0, "","","", "esm", val, "","", ALGO_VERSION
    ]);
    log(`ğŸ—³ï¸ ESM: ${val}`); esmModal.style.display="none"; scheduleNextESM(); saveState();
  });
});

// ===== ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆEWMAï¼‰=====
let prevHR=null, prevRMSSD=null;
let hr_base=70, sd_hr=8, rmssd_base=0.04, sd_rmssd=0.018;
const EWMA=0.05;

// ===== CSVãƒ˜ãƒƒãƒ€ =====
function makeHeader(){
  csvRows=[[ "timestamp","datetime","pid","day","day_iso","session_id","block","condition",
    "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
    "roll_std_h","roll_std_rr","emotion",
    "track_id","track_name","artists","context_uri",
    "hr_base","rmssd_base","sd_hr","sd_rmssd",
    "is_playing","exercise",
    "valid_for_rank",
    "valid_for_rank_none","valid_for_rank_music","valid_for_rank_both",
    "mood","relax","note","event","esm",
    "session_minutes_valid","reason_invalid",
    "algo_version"
  ]];
}

// ===== 1åˆ†åˆ»ã¿å‡¦ç† =====
async function oneTick(){
  const dayStr=new Date().toLocaleDateString("ja-JP"), dayISO=isoDay();
  const pid=(document.getElementById("pid").value||"").trim()||"pid";
  const condition=condSel.value;
  const goal=parseInt(goalSel.value||"120",10);

  const rmssd=calcRMSSD(rrList.slice(-10));
  const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
  const z_hr     = (hr!=null)     ? (hr-hr_base)/sd_hr         : "";
  const z_rmssd  = (rmssd!=null)  ? (rmssd-rmssd_base)/sd_rmssd: "";
  const d_hr     = (prevHR!=null && hr!=null)       ? (hr-prevHR)           : "";
  const d_rmssd  = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD)     : "";
  const emotion  = decideEmotion(hr, rmssd, z_hr, z_rmssd);

  let playing=false, track={track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false};
  try{ const info=extractTrackInfo(await getCurrentPlaying()); playing=!!info.is_playing; track=info; }catch{}

  const exercise = (hr!=null && hr_base!=null && hr >= hr_base+25) ? 1 : 0;

  const valid_for_rank = (condition==="NONE" && playing && !exercise) ? 1 : 0;
  const valid_for_rank_none  = (condition==="NONE"  && !exercise) ? 1 : 0;
  const valid_for_rank_music = (condition==="MUSIC" && playing && !exercise) ? 1 : 0;
  const valid_for_rank_both  = (condition==="BOTH"  && playing && !exercise) ? 1 : 0;

  const gotHR = (hr!=null);
  if(gotHR){
    if(condition==="MUSIC" || condition==="BOTH"){
      if(playing) { validMin++; playMin++; }
    }else{
      validMin++;
    }
  }

  // keep-aliveï¼šMUSIC/BOTHã§2åˆ†å†ç”ŸãŒè½ã¡ã¦ã„ãŸã‚‰é™ã‹ã«èµ·å‹•
  if((condition==="MUSIC" || condition==="BOTH") && !exercise){
    if(playing) noPlayStreak=0;
    else {
      noPlayStreak++;
      if(noPlayStreak>=2){ log("ğŸ§ keep-alive: å†ç”ŸãŒæ­¢ã¾ã£ã¦ã„ã‚‹ãŸã‚èµ·å‹•ã‚’è©¦è¡Œ"); await playPlaylist(PLAYLIST_CALM_MAINTAIN); noPlayStreak=0; }
    }
  }

  updateGoalView(goal);

  if((condition==="MUSIC" || condition==="BOTH") && !exercise){
    const targetKey = emotion==="tension" ? "tension" : (emotion==="calm" ? "calm" : (emotion==="depress" ? "depress" : null));
    if(targetKey) scheduleSwitchIfNeeded(targetKey);
  }

  csvRows.push([
    Date.now(), isoNow(), pid, dayStr, dayISO, sessionId, "block1", condition,
    hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
    "", "", emotion,
    track.track_id, track.track_name, track.artists, track.context_uri,
    hr_base, rmssd_base, sd_hr, sd_rmssd,
    playing?1:0, exercise,
    valid_for_rank,
    valid_for_rank_none, valid_for_rank_music, valid_for_rank_both,
    "", "", "", "", "",
    "", "",
    ALGO_VERSION
  ]);

  // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆã»ã¼ä¸­ç«‹ï¼‰
  if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
    hr_base    = (1-EWMA)*hr_base    + EWMA*hr;
    rmssd_base = (1-EWMA)*rmssd_base + EWMA*rmssd;
    sd_hr      = Math.max(SD_HR_FLOOR,    (1-EWMA)*sd_hr    + EWMA*Math.abs(hr-hr_base));
    sd_rmssd   = Math.max(SD_RMSSD_FLOOR, (1-EWMA)*sd_rmssd + EWMA*Math.abs(rmssd-rmssd_base));
  }

  prevHR=hr; prevRMSSD=rmssd;

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å½“æ—¥åˆè¨ˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  try{
    const u=ensureUser(pid); const d=u.days[dayISO]||ensureUserDay(u, dayISO); d.total_valid=validMin; saveUser(u); setDayBadge(u, dayISO);
  }catch{}

  // ãƒ‡ãƒãƒƒã‚°è¡Œï¼ˆåŸå› åˆ‡ã‚Šåˆ†ã‘ï¼‰
  log(`[tick] gotHR=${gotHR?1:0} playing=${playing?1:0} ex=${exercise} cond=${condition} validMin=${validMin}`);

  // è‡ªå‹•çµ‚äº†
  const autoStop=document.getElementById("autoStop").checked;
  if(autoStop){
    if(validMin>=goal){ log("â± ç›®æ¨™åˆ°é”ã®ãŸã‚è‡ªå‹•çµ‚äº†"); stopSession(); return; }
    if(isPastCutoff()){ log("ğŸŒ™ 23:00ã‚’éããŸãŸã‚è‡ªå‹•çµ‚äº†"); stopSession(); return; }
  }

  saveState();
}
function startTicking(){
  if(timer) clearInterval(timer); // äºŒé‡èµ·å‹•é˜²æ­¢
  timer=setInterval(oneTick, 60*1000);
}

// ===== UI / ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† =====
function updateGoalView(goal){
  const weekly=document.getElementById("weeklyMode").checked;
  if(!weekly){
    const g=goal?goal:parseInt(goalSel.value||"120",10);
    const ok=(validMin>=g);
    goalView.textContent=`é€²æ—: ${validMin} / ${g}åˆ†`+(ok?" âœ…":"");
    goalView.classList.toggle("goalok", ok);
  }else{
    const wkKey=`wk_${new Date().getFullYear()}_${toWeekKey()}`;
    const got=parseInt((loadUser((document.getElementById("pid").value||"pid")).weekly[toWeekKey()]||0),10);
    document.getElementById("weeklyProg").textContent=`ä»Šé€±ã®å–å¾—: ${got} åˆ†`;
    goalView.textContent=`ä»Šã‚»ãƒƒã‚·ãƒ§ãƒ³: ${validMin} åˆ†`;
    goalView.classList.remove("goalok");
  }
}
document.getElementById("weeklyMode").addEventListener("change", (e)=>{
  document.getElementById("weeklyBox").style.display=e.target.checked?"flex":"none";
  updateGoalView();
});

function makeButtonsState(running){
  document.getElementById("btnStart").disabled=running;
  document.getElementById("btnStop").disabled=!running;
  document.getElementById("btnPause").disabled=!running;
  document.getElementById("btnResume").disabled=true;
  btnCsv.disabled=running;
}

function makeHeaderAndReset(){
  makeHeader();
  sessionId=Math.random().toString(36).slice(2,10);
  validMin=0; playMin=0; anyBLE=false; bleDropped=false; lastHadBLE=false;
  currentEmotionKey=null; waitingSwitch=false; noPlayStreak=0;
  votes={tension:[],calm:[],depress:[]};
  lastEmotion="unknown"; lastNonUnknown="unknown"; lastNonUnknownAt=0;
  startedAtMs=Date.now();
}

function startSession(){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼Dayç¢ºå®š
  const pid=(document.getElementById("pid").value||"pid").trim();
  const u=ensureUser(pid); ensureUserDay(u, isoDay()); setDayBadge(u, isoDay());

  makeButtonsState(true);
  makeHeaderAndReset();
  updateGoalView();
  log("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
  scheduleNextESM();

  // MUSIC/BOTH ã¯æœ€åˆã«é™ã‹ã«èµ·å‹•ï¼ˆå†ç”Ÿç«¯æœ«ã‚’èµ·ã“ã™ï¼‰
  if(condSel.value==="MUSIC" || condSel.value==="BOTH"){ playPlaylist(PLAYLIST_CALM_MAINTAIN); }

  startTicking();
  saveState();
}

function stopSession(){
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null;
  makeButtonsState(false);

  const condition=condSel.value;
  let reasons=[];
  if(validMin<60) reasons.push("<60min");
  if((condition==="MUSIC"||condition==="BOTH") && playMin<30) reasons.push("playing<30");
  if(bleDropped) reasons.push("ble_drop");
  const reason_invalid=reasons.join("+")||"";

  if(csvRows.length>1){
    const last=csvRows[csvRows.length-1];
    // æœ«å°¾ã‹ã‚‰3ç•ªç›®= session_minutes_valid, 2ç•ªç›®= reason_invalid, 1ç•ªç›®=algo_version
    last[last.length-3]=String(validMin);
    last[last.length-2]=reason_invalid;
  }else{
    csvRows.push([Date.now(), isoNow(), (document.getElementById("pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), isoDay(), sessionId, "block1", condition,
      "","","","","","","","","","", "","","","",
      hr_base, rmssd_base, sd_hr, sd_rmssd, 0,0, 0,0,0,0, "","","", "end","",
      String(validMin), reason_invalid, ALGO_VERSION
    ]);
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¥/é€±ã«ç¢ºå®šåæ˜ 
  try{
    const pid=(document.getElementById("pid").value||"pid").trim();
    const u=ensureUser(pid); const iso=isoDay(); const day=ensureUserDay(u, iso);
    day.total_valid += validMin;
    day.sessions.push({session_id, condition, minutes:validMin, play_minutes:playMin, reason_invalid,
      started_at:new Date(startedAtMs).toISOString(), ended_at:new Date().toISOString()});
    u.total_valid += validMin;
    bumpWeekly(u, validMin, new Date());
    saveUser(u); setDayBadge(u, iso);
  }catch{}

  clearSavedState();
  log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†, ç†ç”±=${reason_invalid||"ãªã—"}ï¼‰`);
}

document.getElementById("btnPause").onclick=()=>{
  if(!timer) return;
  paused=true;
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null;
  document.getElementById("btnPause").disabled=true;
  document.getElementById("btnResume").disabled=false;
  log("â¸ ä¸€æ™‚åœæ­¢ï¼ˆCSVã¯ã¾ã é–‹ã„ãŸã¾ã¾ï¼‰");
  saveState();
};
document.getElementById("btnResume").onclick=()=>{
  if(timer) return;
  paused=false;
  scheduleNextESM();
  startTicking(); // ãƒ˜ãƒƒãƒ€ã¯å¢—ã‚„ã•ãªã„ï¼ˆç¶™ç¶šï¼‰
  document.getElementById("btnPause").disabled=false;
  document.getElementById("btnResume").disabled=true;
  log("â–¶ å†é–‹");
  saveState();
};

// ===== ã‚¢ãƒ³ã‚± =====
document.getElementById("btnNote").onclick=()=>{
  const mood=document.getElementById("mood").value||"";
  const relax=document.getElementById("relax").value||"";
  const notes=document.getElementById("notes").value||"";
  if(csvRows.length>1){
    const idxMood=csvRows[0].indexOf("mood"), idxRelax=csvRows[0].indexOf("relax"), idxNote=csvRows[0].indexOf("note");
    const last=csvRows[csvRows.length-1]; last[idxMood]=mood; last[idxRelax]=relax; last[idxNote]=notes;
  }
  log("ã‚¢ãƒ³ã‚±è¿½åŠ "); saveState();
};

// ===== CSVä¿å­˜ =====
btnCsv.onclick=()=>{
  const lines=csvRows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const blob=new Blob([lines],{type:"text/csv"});
  const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:`emotion_log_${isoDay()}_${sessionId}.csv`});
  a.click(); URL.revokeObjectURL(a.href);
};

// ===== UIã‚¤ãƒ™ãƒ³ãƒˆ =====
document.getElementById("btnBle").onclick=connectBLE;
document.getElementById("btnSp").onclick=loginSpotify;
document.getElementById("btnStart").onclick=startSession;
document.getElementById("btnStop").onclick=stopSession;
document.getElementById("btnClear").onclick=clearLog;

// pidå¤‰æ›´ã§Dayè¡¨ç¤ºæ›´æ–°
document.getElementById("pid").addEventListener("change",()=>{
  const pid=(document.getElementById("pid").value||"pid").trim();
  const u=ensureUser(pid); ensureUserDay(u, isoDay()); setDayBadge(u, isoDay());
});

// æ—¢ã« code=? ã§æˆ»ã£ã¦ããŸã‚‰è‡ªå‹•äº¤æ›
if(new URLSearchParams(location.search).get("code")) loginSpotify();

// å¾©å…ƒï¼šå½“æ—¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒ»ESMãƒ»ã‚¿ã‚¤ãƒãƒ¼ã‚‚å¾©å¸°
if(loadStateIfAny()){
  updateGoalView();
  const pid=(document.getElementById("pid").value||"pid").trim();
  const u=ensureUser(pid); ensureUserDay(u, isoDay()); setDayBadge(u, isoDay());
  log("ğŸ§© å‰å›ã®é€”ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  // å¾©å¸°æ™‚ã®å…¸å‹ãƒã‚°å¯¾ç­–ï¼šã‚¿ã‚¤ãƒãƒ¼äºŒé‡ç¦æ­¢ãƒ»ãƒœã‚¿ãƒ³æ­£è¦åŒ–
  if(paused){
    document.getElementById("btnStart").disabled=true;
    document.getElementById("btnStop").disabled=true;
    document.getElementById("btnPause").disabled=true;
    document.getElementById("btnResume").disabled=false;
  }else{
    makeButtonsState(true);
    scheduleNextESM();
    startTicking();
  }
}

// é›¢è„±è­¦å‘Šï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ or æœªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼‰
window.addEventListener("beforeunload",(e)=>{
  const running = !document.getElementById("btnStop").disabled; // StopãŒæŠ¼ã›ã‚‹ï¼èµ°è¡Œä¸­
  const hasRows = csvRows && csvRows.length>1;
  if(running || hasRows){ e.preventDefault(); e.returnValue=""; }
});
</script>
</body>
</html>
