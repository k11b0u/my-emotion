<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root { color-scheme: light dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:920px;margin:20px auto;padding:0 12px}
  .card{border:1px solid #333;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 1px 4px rgba(0,0,0,.12);background:#121212}
  button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1e1e1e;color:#f1f1f1;cursor:pointer}
  button:hover:not(:disabled){ background:#2a2a2a }
  button:disabled{ background:#2a2a2a; color:#9aa; border-color:#444; opacity:1; cursor:not-allowed }
  code{background:#1a1a1a;padding:2px 6px;border-radius:6px}
  .ok{color:#27c052;font-weight:700}.bad{color:#ff5252;font-weight:700}.muted{color:#b0b0b0}
  input,textarea,select{width:100%;padding:8px;border:1px solid #444;border-radius:10px;background:#1a1a1a;color:#eee}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > * { flex:1 }
  .logbox{white-space:pre-wrap;height:180px;overflow:auto;background:#0f0f0f;color:#e8e8e8;border:1px solid #333;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #444;border-radius:999px;padding:6px 10px;background:#1a1a1a}
  .goalok{color:#27c052}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:#171717;border:1px solid #333;border-radius:14px;padding:18px;max-width:460px;width:92%}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btns button{flex:1}
</style>
</head>
<body>
<h1>Emotion Record</h1>

<div class="card">
  <h2>çŠ¶æ…‹</h2>
  <p>
    BLE: <span id="bleState">æœªæ¥ç¶š</span> ï¼
    Spotify: <span id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
  </p>
  <div class="row">
    <button id="btnBle">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šï¼ˆCOOSPOï¼‰</button>
    <button id="btnSp">Spotifyãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btnStart">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
    <button id="btnStop" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</button>
    <button id="btnPause" disabled>ä¸€æ™‚åœæ­¢</button>
    <button id="btnResume" disabled>å†é–‹</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æç”¨ãƒ©ãƒ™ãƒ«ï¼‰</label>
      <select id="cond">
        <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
        <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
        <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
        <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
      </select>
      <small class="muted">â€» ã“ã“ã¯â€œè§£æç”¨ãƒ©ãƒ™ãƒ«â€ã€‚å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰å´ã§åˆ¶å¾¡ã€‚</small>
    </div>
    <div>
      <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
      <input id="pid" placeholder="hiro" value="hiro"/>
    </div>
    <div>
      <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
      <select id="goalMin">
        <option value="90">90åˆ†</option>
        <option value="120" selected>120åˆ†</option>
        <option value="150">150åˆ†</option>
      </select>
      <div id="goalView" class="muted pill" style="margin-top:6px">é€²æ—: 0 / 120åˆ†</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <label class="pill">
      <input type="checkbox" id="autoStop" checked>
      ç›®æ¨™åˆ°é”/23:00ã§è‡ªå‹•çµ‚äº†
    </label>
    <label class="pill">
      <input type="checkbox" id="weeklyMode">
      é€±åˆè¨ˆã§ç®¡ç†ã™ã‚‹ï¼ˆä¾‹: 480åˆ†/é€±ï¼‰
    </label>
  </div>

  <div class="row" id="weeklyBox" style="display:none;margin-top:6px">
    <div>
      <label>ä»Šé€±ã®ç›®æ¨™åˆè¨ˆï¼ˆåˆ†ï¼‰</label>
      <input type="number" id="weeklyGoal" value="480" min="60" step="30">
    </div>
    <div class="muted" id="weeklyProg" style="align-self:flex-end">ä»Šé€±ã®å–å¾—: 0 åˆ†</div>
  </div>
</div>

<div class="card">
  <h2>ãƒ­ã‚°</h2>
  <pre id="log" class="logbox"></pre>
  <div class="row">
    <button id="btnCsv" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnClear">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<div class="card">
  <h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div class="row">
    <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
    <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
  </div>
  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
  <button id="btnNote">è¿½åŠ </button>
</div>

<!-- ESM ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ">
  <div class="box">
    <h3 style="margin:0 0 8px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="btns">
      <button data-esm="tense">ç·Šå¼µï¼ˆé«˜ã¶ã‚Š/ç„¦ã‚Šï¼‰</button>
      <button data-esm="calm">é®é™ï¼ˆè½ã¡ç€ãï¼‰</button>
      <button data-esm="depress">è½ã¡è¾¼ã¿ï¼ˆæ°—åˆ†â†“ï¼‰</button>
      <button data-esm="skip">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
// ====== è¨­å®š ======
const SPOTIFY_CLIENT_ID = "7838a0cf003644ae8b5f3f75b9eb534e"; // â†è‡ªåˆ†ã®Client ID
const REDIRECT_URI       = location.origin + location.pathname;
const SCOPES = [
  "user-read-playback-state","user-modify-playback-state",
  "playlist-read-private","playlist-read-collaborative","streaming"
].join(" ");
const PLAYLIST_TENSION_TO_CALM = "spotify:playlist:6lEP2HI9ecRpSoHQNRTok7"; // ç·Šå¼µâ†’é®é™
const PLAYLIST_DEPRESS_TO_LIFT = "spotify:playlist:0TFRed2ZNnofW4uGxjytvT"; // è½ã¡è¾¼ã¿â†’ãƒªãƒ•ãƒˆã‚¢ãƒƒãƒ—
const PLAYLIST_CALM_MAINTAIN   = "spotify:playlist:2m9HoHfpO0tk5eky1fopVu"; // é®é™ç¶­æŒ
const ALGO_VERSION = "v1.2"; // ãƒ­ã‚°ã«æ®‹ã™

// ===== Zã—ãã„å€¤ãƒ»æŠ•ç¥¨ãƒ»ç¶­æŒï¼ˆç ”ç©¶å›ºå®šï¼‰ =====
const ZTH = {
  T_RMSSD_STRONG: -0.60,
  T_RMSSD_SOFT:   -0.30,
  T_HR_HELP:       0.20,
  C_RMSSD_STRONG:  0.60,
  C_RMSSD_SOFT:    0.30,
  C_HR_HELP:       0.20,
  D_HR_LOW:       -0.40,
  D_RMSSD_LOW:    -0.20,
  D_RMSSD_HIGH:    0.10
};
const VOTE_WIN = 5, VOTE_NEED = 3, SEG_MIN_MIN = 3, WARMUP_MIN = 3;

// ===== SDã®ä¸‹é™ï¼ˆç™ºæ•£é˜²æ­¢ï¼‰ =====
const SD_HR_FLOOR = 3.0;      // bpm
const SD_RMSSD_FLOOR = 0.015; // ç§’ (=15ms)

// ===== é‹ç”¨è£œåŠ© =====
const CUTOFF_HOUR = 23; // 23:00ã§è‡ªå‹•çµ‚äº†

// ===== è¦ç´  =====
const logEl = document.getElementById("log");
const bleStateEl = document.getElementById("bleState");
const spStateEl  = document.getElementById("spState");
const btnCsv = document.getElementById("btnCsv");
const btnClear = document.getElementById("btnClear");
const condSel = document.getElementById("cond");
const goalSel = document.getElementById("goalMin");
const goalView = document.getElementById("goalView");
const esmModal = document.getElementById("esmModal");

// ===== çŠ¶æ…‹å¤‰æ•° =====
let hr = null, rrList = [];
let timer = null, esmTimer = null;
let sessionId = Math.random().toString(36).slice(2,10);
let spotifyAccessToken = null, spotifyRefreshToken = null, spotifyTokenExpAt = 0;
let csvRows = [[]];
let validMin = 0, playMin = 0, anyBLE = false, bleDropped = false, lastHadBLE = false;
let currentEmotionKey = null, waitingSwitch = false;
let votes = { tension:[], calm:[], depress:[] };
let lastEmotion = "unknown", lastNonUnknown = "unknown", lastNonUnknownAt = 0;
let startedAtMs = 0, paused = false;

// ===== ä¾¿åˆ©é–¢æ•° =====
function pushVote(key, ok){ const a=votes[key]; a.push(ok?1:0); if(a.length>VOTE_WIN)a.shift(); return a.reduce((x,y)=>x+y,0)>=VOTE_NEED; }
function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = ""; }
function isoNow(){ return new Date().toISOString().replace("T"," ").slice(0,19); }
function isoDay(){ return new Date().toISOString().slice(0,10); }
function csvEscape(val){ if(val==null) return ""; const s=String(val); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
function randomMinutes(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function isPastCutoff(){ const now=new Date(); return now.getHours()>=CUTOFF_HOUR; }
function weekNumber(d=new Date()){
  const dt=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum=dt.getUTCDay()||7; dt.setUTCDate(dt.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(dt.getUTCFullYear(),0,1));
  return Math.ceil((((dt-yearStart)/86400000)+1)/7);
}

// ==== UI: é€±ç®¡ç†ãƒˆã‚°ãƒ« ====
document.getElementById("weeklyMode").addEventListener("change", (e)=>{
  document.getElementById("weeklyBox").style.display = e.target.checked ? "flex":"none";
  updateGoalView();
});

// ---- RMSSDï¼ˆRR=ç§’ï¼‰ã€‚å¤–ã‚Œå€¤0.3ã€œ2.0sã®ã¿æ¡ç”¨
function calcRMSSD(rrs){
  const xs = rrs.filter(x => x>=0.3 && x<=2.0);
  if(xs.length < 3) return null;
  let sum=0, n=0;
  for(let i=1;i<xs.length;i++){ const d=xs[i]-xs[i-1]; sum += d*d; n++; }
  return Math.sqrt(sum/n);
}

// ============ Web Bluetooth ============
async function connectBLE(){
  try{
    log("BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev = await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}], optionalServices:["heart_rate"]});
    const server = await dev.gatt.connect();
    const service = await server.getPrimaryService("heart_rate");
    const ch = await service.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged", (e)=>{
      const v=e.target.value;
      const flags=v.getUint8(0), format16=(flags&0x01)!==0, hasRR=(flags&0x10)!==0;
      hr = format16? v.getUint16(1,true) : v.getUint8(1);
      anyBLE = true; lastHadBLE = true;
      let idx = format16?3:2; const rrLocal=[];
      if(hasRR){ while(idx+1<v.byteLength){ rrLocal.push(v.getUint16(idx,true)/1024.0); idx+=2; } }
      if(rrLocal.length){ rrList.push(...rrLocal); if(rrList.length>60) rrList = rrList.slice(-60); }
      bleStateEl.textContent = `æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
    });
    dev.addEventListener("gattserverdisconnected", ()=>{ bleStateEl.textContent="åˆ‡æ–­"; if(lastHadBLE) bleDropped=true; lastHadBLE=false; });
    bleStateEl.textContent = "æ¥ç¶šå®Œäº†"; log("BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){ log("BLE error: "+err.message); bleStateEl.textContent="æœªæ¥ç¶š"; }
}

// ============ Spotify (PKCE) ============
function base64url(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
async function pkce(){ const ver=base64url(crypto.getRandomValues(new Uint8Array(32))); const digest=await crypto.subtle.digest("SHA-256", new TextEncoder().encode(ver)); const chal=base64url(digest); sessionStorage.setItem("pkce_verifier", ver); return chal; }
async function loginSpotify(){
  const code=new URLSearchParams(location.search).get("code");
  if(!code){
    const challenge=await pkce();
    location.href = "https://accounts.spotify.com/authorize?" + new URLSearchParams({
      client_id:SPOTIFY_CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,
      code_challenge_method:"S256",code_challenge:challenge
    });
    return;
  }
  const ver=sessionStorage.getItem("pkce_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code", code, redirect_uri:REDIRECT_URI, client_id:SPOTIFY_CLIENT_ID, code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const tok=await r.json();
  if(tok.access_token){
    spotifyAccessToken=tok.access_token; spotifyRefreshToken=tok.refresh_token||null; spotifyTokenExpAt=Date.now()+((tok.expires_in||3600)*1000);
    spStateEl.textContent="ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿"; log("Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†"); history.replaceState({}, "", REDIRECT_URI);
  }else{ log("Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(tok)); }
}
async function refreshSpotifyIfNeeded(){
  if(!spotifyRefreshToken) return;
  if(Date.now()<spotifyTokenExpAt-30000) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:spotifyRefreshToken,client_id:SPOTIFY_CLIENT_ID});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const tok=await r.json();
  if(tok.access_token){ spotifyAccessToken=tok.access_token; spotifyTokenExpAt=Date.now()+((tok.expires_in||3600)*1000); log("Spotify: ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°"); }
}
async function spRequest(method,url,body){ await refreshSpotifyIfNeeded(); if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url,{method,headers:{"Authorization":"Bearer "+spotifyAccessToken,"Content-Type":"application/json"},body:body?JSON.stringify(body):undefined});
}
async function ensureShuffleOn(){ try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }catch(e){ log("shuffle err: "+e.message);} }
async function getCurrentPlaying(){ try{ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing"); if(r.status===204) return null; return await r.json(); }catch(_){ return null; } }
function extractTrackInfo(j){
  try{
    if(!j||!j.is_playing||!j.item) return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};
    const item=j.item, artists=(item.artists||[]).map(a=>a.name).join(", "), ctx=(j.context&&j.context.uri)?j.context.uri:"";
    return {track_id:item.id||"",track_name:item.name||"",artists,context_uri:ctx,duration_ms:item.duration_ms||0,progress_ms:j.progress_ms||0,is_playing:!!j.is_playing};
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false}; }
}
async function getDevices(){ const r=await spRequest("GET","https://api.spotify.com/v1/me/player/devices"); try{ return (await r.json()).devices||[]; }catch{ return []; } }
async function ensureActiveDevice(){
  const devs=await getDevices(); const active=devs.find(d=>d.is_active)||devs[0];
  if(!active){ log("Spotify: å†ç”Ÿã§ãã‚‹ç«¯æœ«ãªã—"); return null; }
  await spRequest("PUT","https://api.spotify.com/v1/me/player",{device_ids:[active.id],play:false});
  return active.id;
}
async function playPlaylist(uri){
  await ensureShuffleOn();
  const devId=await ensureActiveDevice(); if(!devId){ log("playä¸­æ­¢: ãƒ‡ãƒã‚¤ã‚¹ãªã—"); return; }
  const r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(devId),{context_uri:uri,position_ms:0});
  if(!r.ok) log("play err: "+(await r.text()).slice(0,200));
}

// ===== ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåˆ‡æ›¿ï¼šæ›²æœ«ã®ã¿ï¼ˆ5åˆ†å¾…ã£ã¦æ¥ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey || waitingSwitch) return;
  waitingSwitch = true;
  const uri = targetKey==="tension" ? PLAYLIST_TENSION_TO_CALM :
              targetKey==="depress" ? PLAYLIST_DEPRESS_TO_LIFT : PLAYLIST_CALM_MAINTAIN;
  const deadline=Date.now()+5*60*1000; let allow=false;
  while(Date.now()<deadline){
    let info=extractTrackInfo(await getCurrentPlaying());
    if(!info.is_playing || !info.duration_ms) break;
    const remain=Math.max(0, info.duration_ms-(info.progress_ms||0));
    if(remain<=3500){ allow=true; break; }
    await new Promise(r=>setTimeout(r,1500));
  }
  if(allow){ await playPlaylist(uri); currentEmotionKey=targetKey; log(`ğŸµ Playlist â†’ ${targetKey}`); }
  else{ log("ğŸµ Switch skipped (no end-of-track within 5min)"); }
  waitingSwitch = false;
}

// ===== åˆ¤å®šï¼ˆZï¼‹å¤šæ•°æ±ºï¼‹3åˆ†ç¶­æŒï¼‹åºç›¤WARMUPï¼‰
function decideEmotion(hrValue, rmssd, z_hr, z_rmssd){
  if (rmssd==null || z_hr==="" || z_rmssd==="") return "unknown";
  if (Date.now()-startedAtMs >= WARMUP_MIN*60*1000){
    if (lastNonUnknown!=="unknown" && (Date.now()-lastNonUnknownAt) < SEG_MIN_MIN*60*1000) return lastNonUnknown;
  }
  const candT = (z_rmssd<=ZTH.T_RMSSD_STRONG) || (z_rmssd<=ZTH.T_RMSSD_SOFT && z_hr>=ZTH.T_HR_HELP);
  const candC = (z_rmssd>=ZTH.C_RMSSD_STRONG) || (z_rmssd>=ZTH.C_RMSSD_SOFT && z_hr<=ZTH.C_HR_HELP);
  const candD = (z_hr<=ZTH.D_HR_LOW && z_rmssd>=ZTH.D_RMSSD_LOW && z_rmssd<=ZTH.D_RMSSD_HIGH);
  const okC=pushVote("calm",candC), okT=pushVote("tension",candT), okD=pushVote("depress",candD);
  let decided="unknown"; if(okC) decided="calm"; else if(okT) decided="tension"; else if(okD) decided="depress";
  if(decided!=="unknown" && (Date.now()-startedAtMs)>=WARMUP_MIN*60*1000){ lastNonUnknown=decided; lastNonUnknownAt=Date.now(); }
  lastEmotion = decided; return decided;
}

// ====== ESM ======
function scheduleNextESM(){ clearTimeout(esmTimer); const m=randomMinutes(28,34); esmTimer=setTimeout(()=>{ esmModal.style.display="flex"; }, m*60*1000); }
esmModal.addEventListener("click",(e)=>{ if(e.target===esmModal) esmModal.style.display="none"; });
esmModal.querySelectorAll("button[data-esm]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const val=btn.getAttribute("data-esm");
    csvRows.push([ Date.now(), isoNow(), (document.getElementById("pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), isoDay(), sessionId, "block1", condSel.value,
      "","","","","","","","","","",
      "","","","", "","","","", 0,0, 0,0,0,0, "","","", "esm", val, "","", ALGO_VERSION
    ]);
    log(`ğŸ—³ï¸ ESM: ${val}`); esmModal.style.display="none"; scheduleNextESM();
  });
});

// ===== ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆEWMAï¼‰
let prevHR=null, prevRMSSD=null;
let hr_base=70, sd_hr=8, rmssd_base=0.04, sd_rmssd=0.018;
const EWMA=0.05;

// ===== CSVãƒ˜ãƒƒãƒ€
function makeHeader(){
  csvRows = [[
    "timestamp","datetime","pid","day","day_iso","session_id","block","condition",
    "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
    "roll_std_h","roll_std_rr","emotion",
    "track_id","track_name","artists","context_uri",
    "hr_base","rmssd_base","sd_hr","sd_rmssd",
    "is_playing","exercise",
    "valid_for_rank",
    "valid_for_rank_none","valid_for_rank_music","valid_for_rank_both",
    "mood","relax","note",
    "event","esm",
    "session_minutes_valid","reason_invalid",
    "algo_version"
  ]];
}

// ===== 1åˆ†åˆ»ã¿å‡¦ç†ï¼ˆé–‹å§‹ãƒ»å†é–‹ã®ä¸¡æ–¹ã‹ã‚‰å‘¼ã¶ï¼‰
function startTicking(){
  timer = setInterval(async ()=>{
    const dayStr=new Date().toLocaleDateString("ja-JP"), dayISO=isoDay();
    const pid=(document.getElementById("pid").value||"").trim()||"pid";
    const condition=condSel.value;
    const goal=parseInt(goalSel.value||"120",10);

    const rmssd=calcRMSSD(rrList.slice(-10));
    const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
    const z_hr     = (hr!=null)     ? (hr-hr_base)/sd_hr         : "";
    const z_rmssd  = (rmssd!=null)  ? (rmssd-rmssd_base)/sd_rmssd: "";
    const d_hr     = (prevHR!=null && hr!=null)       ? (hr-prevHR)           : "";
    const d_rmssd  = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD)     : "";
    const emotion  = decideEmotion(hr, rmssd, z_hr, z_rmssd);

    let playing=false, track={track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false};
    try{ const info=extractTrackInfo(await getCurrentPlaying()); playing=!!info.is_playing; track=info; }catch{}

    const exercise = (hr!=null && hr_base!=null && hr >= hr_base+25) ? 1 : 0;

    const valid_for_rank = (condition==="NONE" && playing && !exercise) ? 1 : 0;
    const valid_for_rank_none  = (condition==="NONE"  && !exercise) ? 1 : 0;
    const valid_for_rank_music = (condition==="MUSIC" && playing && !exercise) ? 1 : 0;
    const valid_for_rank_both  = (condition==="BOTH"  && playing && !exercise) ? 1 : 0;

    const gotHR = (hr!=null);
    if(gotHR){
      if(condition==="MUSIC" || condition==="BOTH"){
        if(playing) validMin++, playMin++;
      }else{
        validMin++;
      }
    }

    updateGoalView(goal);

    if((condition==="MUSIC" || condition==="BOTH") && !exercise){
      const targetKey = emotion==="tension" ? "tension" : (emotion==="calm" ? "calm" : (emotion==="depress" ? "depress" : null));
      if(targetKey) scheduleSwitchIfNeeded(targetKey);
    }

    csvRows.push([
      Date.now(), isoNow(), pid, dayStr, dayISO, sessionId, "block1", condition,
      hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
      "", "", emotion,
      track.track_id, track.track_name, track.artists, track.context_uri,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      playing?1:0, exercise,
      valid_for_rank,
      valid_for_rank_none, valid_for_rank_music, valid_for_rank_both,
      "", "", "",
      "", "",
      "", "",
      ALGO_VERSION
    ]);

    if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
      hr_base    = (1-EWMA)*hr_base    + EWMA*hr;
      rmssd_base = (1-EWMA)*rmssd_base + EWMA*rmssd;
      sd_hr      = Math.max(SD_HR_FLOOR, (1-EWMA)*sd_hr      + EWMA*Math.abs(hr-hr_base));
      sd_rmssd   = Math.max(SD_RMSSD_FLOOR, (1-EWMA)*sd_rmssd + EWMA*Math.abs(rmssd-rmssd_base));
    }

    prevHR=hr; prevRMSSD=rmssd;

    // è‡ªå‹•çµ‚äº†ï¼ˆç›®æ¨™/23:00ï¼‰
    const autoStop = document.getElementById("autoStop").checked;
    if(autoStop){
      if(validMin >= goal){ log("â± ç›®æ¨™åˆ°é”ã®ãŸã‚è‡ªå‹•çµ‚äº†"); stopSession(); return; }
      if(isPastCutoff()){   log("ğŸŒ™ 23:00ã‚’éããŸãŸã‚è‡ªå‹•çµ‚äº†"); stopSession(); return; }
    }
  }, 60*1000);
}

// ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹/åœæ­¢/ä¸€æ™‚åœæ­¢/å†é–‹ =====
function updateGoalView(goal){
  const weekly = document.getElementById("weeklyMode").checked;
  if(!weekly){
    const g = goal ? goal : parseInt(goalSel.value||"120",10);
    const ok = (validMin >= g);
    goalView.textContent = `é€²æ—: ${validMin} / ${g}åˆ†` + (ok ? " âœ…" : "");
    goalView.classList.toggle("goalok", ok);
  }else{
    const wkKey = `wk_${new Date().getFullYear()}_${weekNumber()}`;
    const got = parseInt(localStorage.getItem(wkKey)||"0",10);
    document.getElementById("weeklyProg").textContent = `ä»Šé€±ã®å–å¾—: ${got} åˆ†`;
    goalView.textContent = `ä»Šã‚»ãƒƒã‚·ãƒ§ãƒ³: ${validMin} åˆ†`;
    goalView.classList.remove("goalok");
  }
}

function makeButtonsState(running){
  document.getElementById("btnStart").disabled = running;
  document.getElementById("btnStop").disabled  = !running;
  document.getElementById("btnPause").disabled = !running;
  document.getElementById("btnResume").disabled= true;
  btnCsv.disabled = running;
}

function makeHeaderAndReset(){
  makeHeader();
  sessionId = Math.random().toString(36).slice(2,10);
  validMin=0; playMin=0; anyBLE=false; bleDropped=false; lastHadBLE=false;
  currentEmotionKey=null; waitingSwitch=false;
  votes={tension:[],calm:[],depress:[]};
  lastEmotion="unknown"; lastNonUnknown="unknown"; lastNonUnknownAt=0;
  startedAtMs=Date.now();
}

function startSession(){
  makeButtonsState(true);
  makeHeaderAndReset();
  updateGoalView();
  log("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
  scheduleNextESM();
  startTicking();
}

function stopSession(){
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null;
  makeButtonsState(false);

  const condition=condSel.value;
  let reasons=[];
  if(validMin<60) reasons.push("<60min");
  if((condition==="MUSIC"||condition==="BOTH") && playMin<30) reasons.push("playing<30");
  if(bleDropped) reasons.push("ble_drop");
  const reason_invalid = reasons.join("+") || "";

  if(csvRows.length>1){
    const last=csvRows[csvRows.length-1];
    last[last.length-3] = validMin.toString();   // session_minutes_valid
    last[last.length-2] = reason_invalid;        // reason_invalid
  }else{
    csvRows.push([Date.now(), isoNow(), (document.getElementById("pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"), isoDay(), sessionId, "block1", condition,
      "","","","","","","","","","", "","","","",
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      0,0, 0,0,0,0, "","","", "end","", validMin.toString(), reason_invalid, ALGO_VERSION
    ]);
  }

  // é€±åˆè¨ˆã«åŠ ç®—ï¼ˆé€±ç®¡ç†ONã®ã¨ãï¼‰
  if(document.getElementById("weeklyMode").checked){
    const wkKey = `wk_${new Date().getFullYear()}_${weekNumber()}`;
    const got = parseInt(localStorage.getItem(wkKey)||"0",10);
    localStorage.setItem(wkKey, String(got + validMin));
    document.getElementById("weeklyProg").textContent = `ä»Šé€±ã®å–å¾—: ${got + validMin} åˆ†`;
  }

  log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†, ç†ç”±=${reason_invalid||"ãªã—"}ï¼‰`);
}

document.getElementById("btnPause").onclick = ()=>{
  if(!timer) return;
  paused = true;
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null;
  document.getElementById("btnPause").disabled = true;
  document.getElementById("btnResume").disabled = false;
  log("â¸ ä¸€æ™‚åœæ­¢ï¼ˆCSVã¯ã¾ã é–‹ã„ãŸã¾ã¾ï¼‰");
};

document.getElementById("btnResume").onclick = ()=>{
  if(timer) return;
  paused = false;
  scheduleNextESM();
  startTicking();
  document.getElementById("btnPause").disabled = false;
  document.getElementById("btnResume").disabled = true;
  log("â–¶ å†é–‹");
};

// ===== ã‚¢ãƒ³ã‚±ï¼ˆç›´è¿‘è¡Œã¸è¿½è¨˜ï¼‰
document.getElementById("btnNote").onclick = ()=>{
  const mood=document.getElementById("mood").value||"";
  const relax=document.getElementById("relax").value||"";
  const notes=document.getElementById("notes").value||"";
  if(csvRows.length>1){
    const idxMood  = csvRows[0].indexOf("mood");
    const idxRelax = csvRows[0].indexOf("relax");
    const idxNote  = csvRows[0].indexOf("note");
    const last = csvRows[csvRows.length-1];
    last[idxMood]=mood; last[idxRelax]=relax; last[idxNote]=notes;
  }
  log("ã‚¢ãƒ³ã‚±è¿½åŠ ");
};

// ===== CSVä¿å­˜ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾å¿œï¼‰
btnCsv.onclick = ()=>{
  const lines = csvRows.map(r => r.map(csvEscape).join(",")).join("\n");
  const blob  = new Blob([lines], {type:"text/csv"});
  const a = Object.assign(document.createElement("a"), {
    href: URL.createObjectURL(blob),
    download: `emotion_log_${isoDay()}_${sessionId}.csv`
  });
  a.click(); URL.revokeObjectURL(a.href);
};

// ===== UIã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("btnBle").onclick = connectBLE;
document.getElementById("btnSp").onclick = loginSpotify;
document.getElementById("btnStart").onclick = startSession;
document.getElementById("btnStop").onclick = stopSession;
document.getElementById("btnClear").onclick = clearLog;

// æ—¢ã« code=? ã§æˆ»ã£ã¦ããŸã‚‰è‡ªå‹•äº¤æ›
if(new URLSearchParams(location.search).get("code")) loginSpotify();
</script>
</body>
</html>
