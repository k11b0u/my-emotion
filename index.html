<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root{
    color-scheme: light dark;
    --bg:#0f1115; --panel:#161a22; --panel2:#131722; --line:#283143; --txt:#eef2f7; --muted:#9aa6b2;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --pri:#4f46e5; --acc:#06b6d4;
  }
  html,body{background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
  h1{font-size:22px;margin:0}
  h2{font-size:18px;margin:0 0 8px}

  /* === ã‚¯ãƒªãƒƒã‚¯ä¸èƒ½ã®æ ¹æœ¬å¯¾ç­–ï¼šstickyã‚’ä½¿ã‚ãªã„ / ä½™è¨ˆãªè¢«ã‚Šç„¡ã— === */
  .topbar{
    position:static;             /* â† stickyã«ã—ãªã„ */
    z-index:auto;
    background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.85));
    border-bottom:1px solid var(--line);
  }
  .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
  .wrap{max-width:1160px;margin:0 auto}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--panel2);font-size:13px}

  .grid{display:grid;gap:12px;margin:12px 14px 14px}
  @media (min-width:980px){ .grid{grid-template-columns:1.05fr .95fr} }

  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 0}

  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#1c2130;color:var(--txt);cursor:pointer;transition:.15s;position:relative;z-index:5}
  .btn:hover:not(:disabled){ transform:translateY(-1px); background:#22283a }
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn-primary{background:linear-gradient(180deg,#3b82f6,#4f46e5);border-color:#3840a8}
  .btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d}
  .btn-ghost{background:transparent}

  .switch{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;background:var(--panel2);padding:8px 10px}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#111525;color:var(--txt)}
  .muted{color:var(--muted);font-size:13px}
  .logbox{white-space:pre-wrap;height:260px;overflow:auto;background:#0c111b;color:#e6ebf2;border:1px solid var(--line);
          border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace}
  .progress{height:12px;background:#0c111b;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  details > summary{cursor:pointer}

  /* === ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å¿…è¦æ™‚ã®ã¿è¡¨ç¤ºã€‚æ®‹ç•™ã—ã¦ã‚‚ã‚¯ãƒªãƒƒã‚¯ã‚’å¡ãŒãªã„ã‚ˆã†åˆ¶å¾¡ === */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:1000}
  .modal .box{background:#121827;border:1px solid var(--line);border-radius:16px;padding:18px;max-width:460px;width:92%}
  .tiny{font-size:12px}
</style>
</head>
<body>

<!-- ===== TOP ===== -->
<div class="topbar">
  <div class="toprow wrap">
    <div class="row" style="gap:12px;align-items:center">
      <h1>Emotion Record</h1>
      <div class="chips">
        <span class="chip">BLE: <strong id="bleState">æœªæ¥ç¶š</strong></span>
        <span class="chip">Spotify: <strong id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</strong></span>
        <span class="chip">Day: <strong id="dayBadge">1</strong></span>
        <span class="chip">ã‚¢ãƒ«ã‚´: <strong id="algoBadge">v1.4</strong></span>
        <span class="chip" id="esmNext">ESM: æœªäºˆå®š</span>
        <span class="chip">é¦™ã‚Š: <strong id="scentBadge">off</strong></span>
      </div>
    </div>
    <div class="row" style="gap:8px;flex:0 0 auto">
      <button id="btnBle"   class="btn">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼</button>
      <button id="btnSp"    class="btn">Spotify</button>
      <button id="btnStart" class="btn btn-primary">é–‹å§‹</button>
      <button id="btnPause" class="btn" disabled>ä¸€æ™‚åœæ­¢</button>
      <button id="btnStop"  class="btn btn-danger" disabled>çµ‚äº†</button>
    </div>
  </div>
</div>

<!-- ===== BODY ===== -->
<div class="grid">
  <div class="card">
    <div class="section-title"><h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h2></div>

    <div class="row" style="margin-bottom:10px">
      <div>
        <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æãƒ©ãƒ™ãƒ«ï¼‰</label>
        <select id="cond">
          <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
          <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
          <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
          <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
        </select>
        <div class="muted">â€» å®Ÿéš›ã®ä»‹å…¥ON/OFFã¯ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•åˆ¶å¾¡ã—ã¾ã™ã€‚</div>
      </div>
      <div>
        <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
        <input id="pid" placeholder="hiro" value="hiro"/>
      </div>
      <div>
        <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
        <select id="goalMin">
          <option value="90">90åˆ†</option>
          <option value="120" selected>120åˆ†</option>
          <option value="150">150åˆ†</option>
        </select>
        <div class="muted" id="goalText" style="margin-top:4px">é€²æ—: 0 / 120åˆ†</div>
        <div class="progress" aria-label="ä»Šæ—¥ã®é€²æ—"><div id="goalBar" class="bar"></div></div>
      </div>
    </div>

    <div class="row" style="align-items:center;margin-bottom:10px;gap:12px">
      <div style="max-width:260px">
        <label class="muted">å®Ÿé¨“æ—¥ï¼ˆDayï¼‰ã‚’æ‰‹å‹•ã§èª¿æ•´</label>
        <div class="row" style="gap:6px;align-items:center">
          <button id="dayMinus" class="btn">âˆ’</button>
          <input id="dayNum" type="number" min="1" value="1" style="text-align:center">
          <button id="dayPlus" class="btn">ï¼‹</button>
        </div>
      </div>
      <div class="switch">
        <input type="checkbox" id="autoStop" checked>
        <label for="autoStop">ç›®æ¨™åˆ°é”ã§è‡ªå‹•çµ‚äº†</label>
      </div>
    </div>

    <details>
      <summary class="muted tiny">Spotifyç–é€šãƒ†ã‚¹ãƒˆ</summary>
      <div class="row" style="margin-top:8px">
        <button id="btnPlayCalm" class="btn">Calmç¶­æŒã‚’å†ç”Ÿ</button>
        <button id="btnPlayTen"  class="btn">ç·Šå¼µâ†’é®é™ã‚’å†ç”Ÿ</button>
        <button id="btnPlayDep"  class="btn">è½ã¡è¾¼ã¿â†’ãƒªãƒ•ãƒˆ</button>
      </div>
      <div class="muted tiny">éŸ³ãŒå‡ºãªã„å ´åˆï¼šSpotifyã‚¢ãƒ—ãƒªã§1æ›²å†ç”Ÿâ†’ä¸€æ™‚åœæ­¢â†’ã“ã®ç”»é¢ã€‚</div>
    </details>

    <details>
      <summary class="muted tiny">é¦™ã‚Šãƒ†ã‚¹ãƒˆï¼ˆSwitchBot Botï¼‰</summary>
      <div class="row" style="margin-top:8px">
        <button id="btnScentTen" class="btn">ç·Šå¼µç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentCalm" class="btn">é®é™ç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentDep" class="btn">è½ã¡è¾¼ã¿ç”¨Botã‚’1å›æŠ¼ã—</button>
        <button id="btnScentOff" class="btn">ç›´è¿‘ONã®Botã‚’2å›æŠ¼ã—ï¼ˆOFFï¼‰</button>
      </div>
    </details>

    <div class="section-title" style="margin-top:10px"><h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2></div>
    <div class="row">
      <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
      <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
    </div>
    <label style="margin-top:6px;display:block">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
    <div class="row" style="margin-top:8px"><button id="btnNote" class="btn">ã‚¢ãƒ³ã‚±è¿½åŠ </button></div>
  </div>

  <div class="card">
    <div class="section-title"><h2>ãƒ­ã‚°</h2></div>
    <pre id="log" class="logbox" aria-live="polite"></pre>
    <div class="row" style="gap:8px;flex:0 0 auto;margin-top:10px">
      <button id="btnCsv" class="btn" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="btnClear" class="btn btn-ghost">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="muted tiny" style="margin-top:6px">â€»ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå¾©å…ƒå¯ï¼‰ã€‚</div>
  </div>
</div>

<!-- ===== ESM ===== -->
<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ">
  <div class="box">
    <h3 style="margin:0 0 6px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted tiny" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="row">
      <button data-esm="tense"   class="btn">ç·Šå¼µ</button>
      <button data-esm="calm"    class="btn">é®é™</button>
      <button data-esm="depress" class="btn">è½ã¡è¾¼ã¿</button>
      <button data-esm="skip"    class="btn">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
/* ===== ãƒ­ã‚° & åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $=s=>document.querySelector(s);
function log(s){const el=$("#log");el.textContent+=s+"\n";el.scrollTop=el.scrollHeight;}
window.addEventListener("error",e=>log(`âš ï¸ JS: ${e.message}`));
window.addEventListener("unhandledrejection",e=>log(`âš ï¸ Promise: ${e.reason}`));

/* ===== ç ”ç©¶å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===== */
const ALGO_VERSION="v1.4"; $("#algoBadge").textContent=ALGO_VERSION;
const ZTH={T_RMSSD_STRONG:-0.60,T_RMSSD_SOFT:-0.30,T_HR_HELP:0.20,C_RMSSD_STRONG:0.60,C_RMSSD_SOFT:0.30,C_HR_HELP:0.20,D_HR_LOW:-0.40,D_RMSSD_LOW:-0.20,D_RMSSD_HIGH:0.10};
const VOTE_WIN=5,VOTE_NEED=3,SEG_MIN_MIN=3,WARMUP_MIN=3,SD_HR_FLOOR=3,SD_RMSSD_FLOOR=0.015;

const SPOTIFY_CLIENT_ID="7838a0cf003644ae8b5f3f75b9eb534e";
const REDIRECT_URI=location.origin+location.pathname;
const SCOPES=["user-read-playback-state","user-modify-playback-state","playlist-read-private","playlist-read-collaborative","streaming"].join(" ");
const PLAYLIST_TENSION_TO_CALM="spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT="spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN ="spotify:playlist:2m9HoHfpO0tk5eky1fopVu";

const SWITCHBOT_TOKEN="3ca5812e6d4bc4a01e73bd603eb854734d2d97937e543cdf56fb1467ed4e0810a23cccfa70f26238d7d9f2ff310b940a";
const SWITCHBOT_TENSION_ID="E16A84063A18", SWITCHBOT_RELAX_ID="E16A8386467A", SWITCHBOT_DEPRESS_ID="D23534382415";

/* ===== JSTæ—¥æ™‚ ===== */
function nowJstObj(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Tokyo"}));}
function dayIsoJST(d=nowJstObj()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");return`${y}-${m}-${da}`;}
function datetimeStrJST(d=nowJstObj()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");const hh=String(d.getHours()).padStart(2,"0"),mi=String(d.getMinutes()).padStart(2,"0"),ss=String(d.getSeconds()).padStart(2,"0");return`${y}-${m}-${da} ${hh}:${mi}:${ss}`;}
function getTimeBinJST(d=nowJstObj()){const h=d.getHours();if(h>=18&&h<22)return"evening";if(h>=22||h<1)return"late";if(h>=1&&h<3)return"deep";if(h>=3&&h<6)return"early";return"day";}
function randomMinutes(min,max){return Math.floor(min+Math.random()*(max-min+1));}
function csvEscape(v){if(v==null)return"";const s=String(v);return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}

/* ===== Dayä¿å­˜ï¼ˆå …ç‰¢ï¼‰ ===== */
function toSafeDayNum(x){const n=parseInt(x,10);return Number.isFinite(n)&&n>=1?n:1;}
function setDayBadgeNum(n){const v=toSafeDayNum(n); $("#dayBadge").textContent=String(v); $("#dayNum").value=String(v);}

/* ===== çŠ¶æ…‹å¤‰æ•° ===== */
let hr=null,rrList=[],timer=null,esmTimer=null,sessionId=Math.random().toString(36).slice(2,10);
let spotifyAccessToken=null,spotifyRefreshToken=null,spotifyTokenExpAt=0;
let csvRows=[[]],validMin=0,playMin=0,anyBLE=false,bleDropped=false,lastHadBLE=false;
let votes={tension:[],calm:[],depress:[]},lastEmotion="unknown",lastNonUnknown="unknown",lastNonUnknownAt=0,startedAtMs=0,isPaused=false;
let currentEmotionKey=null,waitingSwitch=false;
let scentIsOn=false,lastScentDeviceId="",lastScentOpAt=0; const SCENT_COOLDOWN_MS=20000;

/* ===== HRVåŸºæº– ===== */
let prevHR=null,prevRMSSD=null; let hr_base=70,sd_hr=8,rmssd_base=0.04,sd_rmssd=0.018; const EWMA=0.05;
function calcRMSSD(rrs){const xs=rrs.filter(x=>x>=0.3&&x<=2.0);if(xs.length<3)return null;let sum=0,n=0;for(let i=1;i<xs.length;i++){const d=xs[i]-xs[i-1];sum+=d*d;n++;}return Math.sqrt(sum/n);}

/* ===== BLEï¼ˆWeb Bluetoothï¼‰ ===== */
const bleStateEl=$("#bleState");
async function connectBLE(){
  try{
    log("ğŸ©º BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["heart_rate"]});
    const server=await dev.gatt.connect();
    const svc=await server.getPrimaryService("heart_rate");
    const ch = await svc.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged",(e)=>{
      try{
        const raw=e?.target?.value; let v=null;
        if(raw instanceof DataView) v=raw; else if(raw?.buffer instanceof ArrayBuffer) v=new DataView(raw.buffer,raw.byteOffset||0,raw.byteLength||raw.buffer.byteLength);
        else if(raw instanceof ArrayBuffer) v=new DataView(raw);
        if(!(v instanceof DataView)||v.byteLength<2){log("âš ï¸ BLE: short packet");return;}
        const flags=v.getUint8(0); const is16=(flags&0x01)!==0; const hasRR=(flags&0x10)!==0;
        hr = is16 ? (v.byteLength>=3 ? v.getUint16(1,true) : hr) : v.getUint8(1);
        anyBLE=true; lastHadBLE=true;
        if(hasRR){ let idx=is16?3:2; const rrLocal=[]; while(idx+1<v.byteLength){const rr=v.getUint16(idx,true)/1024.0; if(rr>=0.3&&rr<=2.0) rrLocal.push(rr); idx+=2;} if(rrLocal.length){ rrList.push(...rrLocal); if(rrList.length>60) rrList=rrList.slice(-60);} }
        bleStateEl.textContent=`æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
      }catch(err){ log("âš ï¸ BLE parse: "+err.message); }
    });
    dev.addEventListener("gattserverdisconnected",()=>{bleStateEl.textContent="åˆ‡æ–­";if(lastHadBLE)bleDropped=true;lastHadBLE=false;});
    bleStateEl.textContent="æ¥ç¶šå®Œäº†"; log("âœ… BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){ bleStateEl.textContent="æœªæ¥ç¶š"; log("âš ï¸ BLE error: "+err.message); }
}

/* ===== Spotifyï¼ˆPKCE + å†ç”Ÿåˆ¶å¾¡ï¼‰ ===== */
const spStateEl=$("#spState");
function base64url(bytes){return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
async function pkce(){const ver=base64url(crypto.getRandomValues(new Uint8Array(32)));const dig=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver));const chal=base64url(dig);sessionStorage.setItem("pkce_verifier",ver);return chal;}
async function loginSpotify(){
  const code=new URLSearchParams(location.search).get("code");
  if(!code){
    const challenge=await pkce();
    location.href="https://accounts.spotify.com/authorize?"+new URLSearchParams({client_id:SPOTIFY_CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:"S256",code_challenge:challenge});
    return;
  }
  const ver=sessionStorage.getItem("pkce_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:SPOTIFY_CLIENT_ID,code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const t=await r.json();
  if(t.access_token){spotifyAccessToken=t.access_token;spotifyRefreshToken=t.refresh_token||null;spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000);spStateEl.textContent="ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿";log("âœ… Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†");history.replaceState({}, "", REDIRECT_URI);}
  else{log("âš ï¸ Spotify tokenå¤±æ•—: "+JSON.stringify(t));}
}
async function refreshSpotifyIfNeeded(){if(!spotifyRefreshToken)return; if(Date.now()<spotifyTokenExpAt-30000)return; const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:spotifyRefreshToken,client_id:SPOTIFY_CLIENT_ID}); const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body}); const t=await r.json(); if(t.access_token){spotifyAccessToken=t.access_token;spotifyTokenExpAt=Date.now()+((t.expires_in||3600)*1000);log("ğŸ”„ Spotify: ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°");}}
async function spRequest(m,u,b){await refreshSpotifyIfNeeded(); if(!spotifyAccessToken) throw new Error("no token"); return fetch(u,{method:m,headers:{"Authorization":"Bearer "+spotifyAccessToken,"Content-Type":"application/json"},body:b?JSON.stringify(b):undefined});}
async function getDevices(){const r=await spRequest("GET","https://api.spotify.com/v1/me/player/devices");const js=await r.json().catch(()=>({devices:[]}));return js.devices||[];}
async function ensureActiveDevice(){const devs=await getDevices(); if(devs.length===0){log("âš ï¸ å†ç”Ÿç«¯æœ«ãªã—ï¼šSpotifyã‚¢ãƒ—ãƒªã§ä¸€åº¦å†ç”Ÿâ†’åœæ­¢â†’æˆ»ã‚‹"); return null;} const active=devs.find(d=>d.is_active)||devs[0]; try{await spRequest("PUT","https://api.spotify.com/v1/me/player",{device_ids:[active.id],play:false});}catch{} return active.id;}
async function ensureShuffleOn(){try{await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true");}catch{}}
async function getCurrentPlaying(){try{const r=await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing");if(r.status===204)return null;return await r.json();}catch{return null;}}
function extractTrackInfo(j){try{if(!j||!j.is_playing||!j.item)return{track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};const a=(j.item.artists||[]).map(x=>x.name).join(", ");const ctx=(j.context&&j.context.uri)?j.context.uri:"";return{track_id:j.item.id||"",track_name:j.item.name||"",artists:a,context_uri:ctx,duration_ms:j.item.duration_ms||0,progress_ms:j.progress_ms||0,is_playing:!!j.is_playing};}catch{return{track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};}}
async function bootAndPlay(uri){const dev=await ensureActiveDevice(); if(!dev) return false; await ensureShuffleOn(); let r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0}); if(!r.ok){try{await spRequest("POST","https://api.spotify.com/v1/me/player/next?device_id="+encodeURIComponent(dev));}catch{} r=await spRequest("PUT","https://api.spotify.com/v1/me/player/play?device_id="+encodeURIComponent(dev),{context_uri:uri,position_ms:0}); if(!r.ok){log("âš ï¸ playå¤±æ•—");return false;}} return true;}
async function playPlaylist(uri){const ok=await bootAndPlay(uri); if(!ok) log("âš ï¸ å†ç”Ÿä¸å¯ï¼ˆç«¯æœ«/åºƒå‘Šï¼‰");}
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey||waitingSwitch) return; waitingSwitch=true;
  const uri=targetKey==="tension"?PLAYLIST_TENSION_TO_CALM:targetKey==="depress"?PLAYLIST_DEPRESS_TO_LIFT:PLAYLIST_CALM_MAINTAIN;
  const deadline=Date.now()+5*60*1000; let allow=false;
  while(Date.now()<deadline){const info=extractTrackInfo(await getCurrentPlaying()); if(!info.is_playing||!info.duration_ms)break; const remain=Math.max(0,info.duration_ms-(info.progress_ms||0)); if(remain<=3500){allow=true;break;} await new Promise(r=>setTimeout(r,1200));}
  if(allow){await playPlaylist(uri); currentEmotionKey=targetKey; log(`ğŸµ Playlist â†’ ${targetKey}`);} else {log("ğŸµ Switch skipped (no end-of-track within 5min)");}
  waitingSwitch=false;
}

/* ===== å¤šæ•°æ±ºåˆ†é¡ ===== */
function pushVote(key,ok){const a=votes[key];a.push(ok?1:0);if(a.length>VOTE_WIN)a.shift();return a.reduce((x,y)=>x+y,0)>=VOTE_NEED;}
function decideEmotion(hrValue,rmssd,z_hr,z_rmssd){
  if(rmssd==null||z_hr===""||z_rmssd==="") return"unknown";
  if(Date.now()-startedAtMs>=WARMUP_MIN*60*1000){ if(lastNonUnknown!=="unknown"&&(Date.now()-lastNonUnknownAt)<SEG_MIN_MIN*60*1000) return lastNonUnknown; }
  const candT=(z_rmssd<=ZTH.T_RMSSD_STRONG)||(z_rmssd<=ZTH.T_RMSSD_SOFT&&z_hr>=ZTH.T_HR_HELP);
  const candC=(z_rmssd>=ZTH.C_RMSSD_STRONG)||(z_rmssd>=ZTH.C_RMSSD_SOFT&&z_hr<=ZTH.C_HR_HELP);
  const candD=(z_hr<=ZTH.D_HR_LOW&&z_rmssd>=ZTH.D_RMSSD_LOW&&z_rmssd<=ZTH.D_RMSSD_HIGH);
  const okC=pushVote("calm",candC), okT=pushVote("tension",candT), okD=pushVote("depress",candD);
  let decided="unknown"; if(okC)decided="calm"; else if(okT)decided="tension"; else if(okD)decided="depress";
  if(decided!=="unknown"&&(Date.now()-startedAtMs)>=WARMUP_MIN*60*1000){lastNonUnknown=decided;lastNonUnknownAt=Date.now();}
  return lastEmotion=decided;
}

/* ===== é¦™ã‚Šï¼ˆSwitchBot Botï¼‰ ===== */
function canScentOp(){return (Date.now()-lastScentOpAt)>SCENT_COOLDOWN_MS;}
async function switchbotPress(deviceId,times){
  try{const prox=await fetch("/api/switchbot-press",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId,times})}); if(prox.ok) return;}catch{}
  for(let i=0;i<times;i++){
    await fetch(`https://api.switch-bot.com/v1.1/devices/${encodeURIComponent(deviceId)}/commands`,{method:"POST",headers:{"Authorization":SWITCHBOT_TOKEN,"Content-Type":"application/json; charset=utf8"},body:JSON.stringify({command:"press",parameter:"default",commandType:"command"})}).catch(()=>{});
    await new Promise(r=>setTimeout(r,600));
  }
}
async function scentOnFor(deviceId,label){ if(!deviceId||!canScentOp())return; lastScentOpAt=Date.now(); await switchbotPress(deviceId,1); scentIsOn=true; lastScentDeviceId=deviceId; $("#scentBadge").textContent="on"; log(`ğŸŒ«ï¸ é¦™ã‚Š ONï¼ˆ${label}ï¼‰`); }
async function scentOffCurrent(){ if(!scentIsOn||!lastScentDeviceId||!canScentOp())return; lastScentOpAt=Date.now(); await switchbotPress(lastScentDeviceId,2); scentIsOn=false; lastScentDeviceId=""; $("#scentBadge").textContent="off"; log(`ğŸŒ«ï¸ é¦™ã‚Š OFF`); }
function deviceForEmotion(e){ if(e==="tension")return[SWITCHBOT_TENSION_ID,"tension"]; if(e==="depress")return[SWITCHBOT_DEPRESS_ID,"depress"]; if(e==="calm")return[SWITCHBOT_RELAX_ID,"calm"]; return[null,null]; }
async function handleScentForEmotion(emotion,condition,exercise){
  if(!(condition==="SCENT"||condition==="BOTH"))return; if(exercise)return; if(Date.now()-startedAtMs<WARMUP_MIN*60*1000)return;
  const [target,label]=deviceForEmotion(emotion);
  if(target){ if(scentIsOn&&lastScentDeviceId&&lastScentDeviceId!==target){await scentOffCurrent(); await scentOnFor(target,label);} else if(!scentIsOn){ await scentOnFor(target,label); } }
  else { if(scentIsOn){ await scentOffCurrent(); } }
}

/* ===== CSV ===== */
function makeHeader(){csvRows=[[ "timestamp","datetime_jst","pid","day_local","day_iso_jst","day_num","time_bin","session_id","block","condition","hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd","roll_std_h","roll_std_rr","emotion","track_id","track_name","artists","context_uri","hr_base","rmssd_base","sd_hr","sd_rmssd","is_playing","exercise","valid_for_rank","valid_for_rank_none","valid_for_rank_music","valid_for_rank_both","mood","relax","note","event","esm","session_minutes_valid","reason_invalid","algo_version" ]];}

/* ===== 1åˆ†Tick ===== */
function updateGoalView(goal){const g=goal?goal:parseInt($("#goalMin").value||"120",10); $("#goalText").textContent=`é€²æ—: ${validMin} / ${g}åˆ†`; $("#goalBar").style.width=Math.max(0,Math.min(100,(validMin/g)*100))+"%";}
async function oneTick(){
  if(isPaused){log("â›³ ä¸€æ™‚åœæ­¢ä¸­");return;}
  const pid=($("#pid").value||"pid").trim(); const condition=$("#cond").value; const goal=parseInt($("#goalMin").value||"120",10); const dayNum=toSafeDayNum($("#dayNum").value);
  const rmssd=calcRMSSD(rrList.slice(-10)); const rmssd_ms=rmssd!=null?Math.round(rmssd*1000):""; const z_hr=(hr!=null)?(hr-hr_base)/sd_hr:""; const z_rmssd=(rmssd!=null)?(rmssd-rmssd_base)/sd_rmssd:""; const d_hr=(prevHR!=null&&hr!=null)?(hr-prevHR):""; const d_rmssd=(prevRMSSD!=null&&rmssd!=null)?(rmssd-prevRMSSD):""; const emotion=decideEmotion(hr,rmssd,z_hr,z_rmssd);
  let playing=false,info={track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false}; try{info=extractTrackInfo(await getCurrentPlaying()); playing=!!info.is_playing;}catch{}
  const exercise=(hr!=null && hr_base!=null && hr>=hr_base+25)?1:0;
  const valid_for_rank=(condition==="NONE" && playing && !exercise)?1:0, valid_for_rank_none=(condition==="NONE" && !exercise)?1:0, valid_for_rank_music=(condition==="MUSIC" && playing && !exercise)?1:0, valid_for_rank_both=(condition==="BOTH" && playing && !exercise)?1:0;
  const gotHR=(hr!=null); if(gotHR){ if(condition==="MUSIC"||condition==="BOTH"){ if(playing){validMin++; playMin++;} } else { validMin++; } }
  updateGoalView(goal);
  if((condition==="MUSIC"||condition==="BOTH") && !exercise){const key=emotion==="tension"?"tension":(emotion==="calm"?"calm":(emotion==="depress"?"depress":null)); if(key) scheduleSwitchIfNeeded(key);}
  await handleScentForEmotion(emotion,condition,exercise);
  csvRows.push([ Date.now(),datetimeStrJST(),pid,new Date().toLocaleDateString("ja-JP"),dayIsoJST(),dayNum,getTimeBinJST(),sessionId,"block1",condition, hr??"",rmssd??"",rmssd_ms,z_hr===""?"":z_hr,z_rmssd===""?"":z_rmssd,d_hr,d_rmssd,"","",emotion, info.track_id,info.track_name,info.artists,info.context_uri, hr_base,rmssd_base,sd_hr,sd_rmssd, playing?1:0,exercise,valid_for_rank, valid_for_rank_none,valid_for_rank_music,valid_for_rank_both, "","","","","", "","",ALGO_VERSION ]);
  if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){ hr_base=(1-EWMA)*hr_base+EWMA*hr; rmssd_base=(1-EWMA)*rmssd_base+EWMA*rmssd; sd_hr=Math.max(SD_HR_FLOOR,(1-EWMA)*sd_hr+EWMA*Math.abs(hr-hr_base)); sd_rmssd=Math.max(SD_RMSSD_FLOOR,(1-EWMA)*sd_rmssd+EWMA*Math.abs(rmssd-rmssd_base)); }
  prevHR=hr; prevRMSSD=rmssd; log(`[tick JST] HR=${hr??"-"} playing=${playing?1:0} ex=${exercise} emotion=${emotion} scent=${scentIsOn?'on':'off'} validMin=${validMin}`);
  if(!isPaused && $("#autoStop").checked && validMin>=goal){ log("â± ç›®æ¨™åˆ°é”â†’è‡ªå‹•çµ‚äº†"); stopSession(); }
}
function startTicking(){ if(timer) clearInterval(timer); timer=setInterval(oneTick,60*1000); }

/* ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³æ“ä½œ ===== */
function forceCloseModal(){const m=$("#esmModal"); if(m) m.style.display="none";}
function makeButtonsState(running){
  $("#btnStart").disabled=running;
  $("#btnPause").disabled=!running;
  $("#btnStop").disabled=!running;
  $("#btnCsv").disabled=running;
  $("#btnBle").disabled=false;
  $("#btnSp").disabled=false;
  $("#dayMinus").disabled=false;
  $("#dayPlus").disabled=false;
  $("#dayNum").disabled=false;
}
function makeHeaderAndReset(){
  makeHeader();
  sessionId=Math.random().toString(36).slice(2,10);
  validMin=0; playMin=0; anyBLE=false; bleDropped=false; lastHadBLE=false;
  currentEmotionKey=null; waitingSwitch=false;
  votes={tension:[],calm:[],depress:[]};
  lastEmotion="unknown"; lastNonUnknown="unknown"; lastNonUnknownAt=0;
  startedAtMs=Date.now(); isPaused=false; $("#btnPause").textContent="ä¸€æ™‚åœæ­¢";
  scentIsOn=false; lastScentDeviceId=""; lastScentOpAt=0; $("#scentBadge").textContent="off";
}
function startSession(){
  forceCloseModal();
  makeButtonsState(true);
  makeHeaderAndReset();
  updateGoalView();
  log("â–¶ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
  scheduleNextESM();
  if($("#cond").value==="MUSIC"||$("#cond").value==="BOTH"){
    playPlaylist(PLAYLIST_CALM_MAINTAIN).catch(e=>log("Spotifyèµ·å‹•å¤±æ•—: "+e.message));
  }
  oneTick().catch(()=>{});
  startTicking();
}
function stopSession(){
  forceCloseModal();
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null; $("#esmNext").textContent="ESM: æœªäºˆå®š";
  makeButtonsState(false);
  log(`â–  ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†ï¼‰`);
}

/* ===== ESM ===== */
function scheduleNextESM(){
  clearTimeout(esmTimer);
  const m=randomMinutes(28,34);
  const at=Date.now()+m*60*1000;
  const j=nowJstObj(); j.setTime(at);
  $("#esmNext").textContent=`ESM: ${String(j.getHours()).padStart(2,"0")}:${String(j.getMinutes()).padStart(2,"0")}é ƒ`;
  esmTimer=setTimeout(()=>{ if(isPaused) return scheduleNextESM(); $("#esmModal").style.display="flex"; }, m*60*1000);
}
$("#esmModal").addEventListener("click",(e)=>{ if(e.target===$("#esmModal")) $("#esmModal").style.display="none"; });
document.querySelectorAll("#esmModal button[data-esm]").forEach(b=>{
  b.addEventListener("click",()=>{
    $("#esmModal").style.display="none";
    scheduleNextESM();
  });
});

/* ===== UI ãƒãƒ³ãƒ‰ãƒ©ï¼ˆé‡è¤‡ç™»éŒ²ã—ãªã„ï¼‰ ===== */
function onceBind(id,ev,fn){const el=document.getElementById(id); if(!el||el.dataset.bound)return; el.addEventListener(ev,fn); el.dataset.bound="1";}
onceBind("btnBle","click",connectBLE);
onceBind("btnSp","click",loginSpotify);
onceBind("btnStart","click",startSession);
onceBind("btnStop","click",stopSession);
onceBind("btnPause","click",()=>{forceCloseModal(); isPaused=!isPaused; $("#btnPause").textContent=isPaused?"å†é–‹":"ä¸€æ™‚åœæ­¢"; log(isPaused?"â›” ä¸€æ™‚åœæ­¢":"â–¶ å†é–‹");});
onceBind("btnClear","click",()=>{$("#log").textContent="";});
onceBind("dayMinus","click",()=>{setDayBadgeNum(toSafeDayNum($("#dayNum").value)-1);});
onceBind("dayPlus","click",()=>{setDayBadgeNum(toSafeDayNum($("#dayNum").value)+1);});
onceBind("dayNum","change",()=>{setDayBadgeNum($("#dayNum").value);});
onceBind("btnPlayCalm","click",()=>playPlaylist(PLAYLIST_CALM_MAINTAIN));
onceBind("btnPlayTen","click", ()=>playPlaylist(PLAYLIST_TENSION_TO_CALM));
onceBind("btnPlayDep","click", ()=>playPlaylist(PLAYLIST_DEPRESS_TO_LIFT));
onceBind("btnScentTen","click", ()=>scentOnFor(SWITCHBOT_TENSION_ID,"tension-test"));
onceBind("btnScentCalm","click",()=>scentOnFor(SWITCHBOT_RELAX_ID,"calm-test"));
onceBind("btnScentDep","click", ()=>scentOnFor(SWITCHBOT_DEPRESS_ID,"depress-test"));
onceBind("btnScentOff","click", ()=>scentOffCurrent());
onceBind("btnCsv","click",()=>{
  const lines=csvRows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const blob=new Blob([lines],{type:"text/csv"});
  const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:`emotion_log_${dayIsoJST()}_${sessionId}.csv`});
  a.click(); URL.revokeObjectURL(a.href);
});
onceBind("btnNote","click",()=>{ log("ğŸ“ ã‚¢ãƒ³ã‚±è¿½åŠ "); });

/* ===== åˆæœŸçŠ¶æ…‹ï¼šå…¨ãƒœã‚¿ãƒ³ã¯æŠ¼ã›ã‚‹ ===== */
["btnStart","btnBle","btnSp","dayMinus","dayPlus","dayNum"].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=false;});

/* ===== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæˆ»ã‚Šã®è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ ===== */
if(new URLSearchParams(location.search).get("code")) loginSpotify();
</script>
</body>
</html>
